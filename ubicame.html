<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RoadMap - Ub√≠came</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="https://raw.githubusercontent.com/Gokzarag/RoadMap/main/MapTrack.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --sidebar-bg:#1f2933;
      --sidebar-accent:#f9735b;
      --sidebar-accent-soft:#fde3dd;
      --sidebar-text:#f9fafb;
      --sidebar-muted:#9ca3af;
      --main-bg:#f4f5f7;
      --card-bg:#ffffff;
      --border-soft:#e5e7eb;
      --text-main:#111827;
      --text-muted:#6b7280;
      --font:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
  font-family:var(--font);
  background:var(--main-bg);
  color:var(--text-main);
  min-height:100vh;
  margin:0;
}
.layout{
  display:flex;
  width:100%;
  min-height:100vh;
}

/* SIDEBAR */
.sidebar{
  width:235px;
  background:linear-gradient(180deg,#111827,#1f2933);
  color:var(--sidebar-text);
  display:flex;
  flex-direction:column;
  padding:14px 14px 16px;
  position:sticky;
  top:0;
  height:100vh;
}

/* MAIN gen√©rico */
.main{
  flex:1;
  padding:14px 16px 16px;
  overflow:auto;
}

/* Panel gen√©rico (index/agenda/planos/ubicame/documentos) */
.panel{
  background:var(--card-bg);
  border-radius:14px;
  padding:10px 12px 12px;
  border:1px solid var(--border-soft);
  box-shadow:0 8px 28px rgba(15,23,42,0.12);
  display:flex;
  flex-direction:column;
  gap:8px;
  height:calc(100vh - 32px);
}

/* RESPONSI VO M√ìVIL */
@media(max-width:900px){
  .layout{
    flex-direction:column;
  }
  .sidebar{
    width:100%;
    height:auto;
    position:relative;
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
    padding:8px 10px;
    gap:8px;
  }
  .sb-header{
    margin-bottom:0;
  }
  .sb-title span:nth-child(2){
    font-size:13px;
  }
  .sb-section-label{
    display:none;
  }
  .zona-toggle{
    flex-direction:row;
    align-items:center;
    padding:6px 7px;
  }
  .zona-toggle-header{
    display:none;
  }
  .zona-options{
    gap:4px;
  }
  .zona-pill{
    padding:4px 6px;
    font-size:10px;
  }
  .menu{
    flex-direction:row;
    flex-wrap:wrap;
    margin-top:0;
    gap:4px;
  }
  .menu a{
    padding:4px 6px;
    font-size:11px;
  }
  .sb-footer{
    display:none;
  }
  .main{
    padding:8px 8px 10px;
  }
  .panel{
    height:auto;
    min-height:calc(100vh - 70px);
  }
  /* mapas en m√≥vil */
  #map,
  #ubicame-map{
    min-height:55vh;
    height:55vh;
  }
}
@media(max-width:480px){
  .menu a span.icon{display:none;}
  .menu a span{font-size:10px;}
  .zona-pill{
    font-size:9px;
  }
}
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="sb-header">
      <img src="https://raw.githubusercontent.com/Gokzarag/RoadMap/main/MapTrack.png" class="sb-logo" alt="MapTrack" />
      <div class="sb-title">
        <span>RoadMap</span>
        <span>Distribution Platform</span>
      </div>
    </div>

    <div class="sb-section-label">Oficina</div>
    <div class="zona-toggle">
      <div class="zona-toggle-header">
        <span>Selecciona zona activa</span>
      </div>
      <div class="zona-options">
        <button class="zona-pill" id="zona-ate" onclick="setZona('ATE')">Cedi Ate</button>
        <button class="zona-pill" id="zona-chorr" onclick="setZona('0752')">Cadi Chorrillos</button>
      </div>
    </div>

    <div class="sb-section-label">M√≥dulos</div>
    <ul class="menu">
      <li><a href="index.html"><span class="icon">üè†</span><span>Inicio</span></a></li>
      <li><a href="agenda.html"><span class="icon">üìã</span><span>Agenda</span></a></li>
      <li><a href="planos.html"><span class="icon">üó∫Ô∏è</span><span>Planos</span></a></li>
      <li><a href="ubicame.html" class="primary"><span class="icon">üìç</span><span>Ub√≠came</span></a></li>
      <li><a href="documentos.html"><span class="icon">üìë</span><span>Documentos</span></a></li>
    </ul>

    <div class="sb-footer">
      <span>v2.1</span>
      <a href="https://t.me/MapTrack_bot" target="_blank" rel="noopener">Telegram Bot</a>
    </div>
  </aside>

  <main class="main">
    <section class="panel">
      <header class="panel-header">
        <div class="panel-title">
          <h1>Ubicar cliente Sigma</h1>
          <p>Ingresa el c√≥digo del cliente y visualiza su ubicaci√≥n con acceso directo a Google Maps.</p>
          <div class="buscador-box">
            <label for="codigoClienteInput">C√≥digo de Cliente (Deudor Sigma):</label>
            <input type="text" id="codigoClienteInput" placeholder="Ej: 123456" autocomplete="off" spellcheck="false" />
            <button id="buscarClienteBtn" onclick="buscarClienteSigma()">üîç Ubicar Cliente</button>
            <div id="resultadoCliente"></div>
          </div>
        </div>
        <div class="panel-meta">
          <span class="badge-zona-main">Zona: <strong id="badge-zona-text">-</strong></span>
        </div>
      </header>

      <div class="map-wrapper">
        <div id="ubicame-map"></div>
      </div>
    </section>
  </main>
</div>

<script>
/* Zona compartida */
function setZona(z){
  localStorage.setItem('maptrack_zona', z);
  pintarZonaSidebar();
}
function getZona(){
  return localStorage.getItem('maptrack_zona') || '0752';
}
function pintarZonaSidebar(){
  const z = getZona();
  const ate = document.getElementById('zona-ate');
  const ch = document.getElementById('zona-chorr');
  if (ate && ch){
    ate.classList.toggle('active', z !== '0752');
    ch.classList.toggle('active', z === '0752');
  }
  const badge = document.getElementById('badge-zona-text');
  if (badge) badge.textContent = (z === '0752' ? 'Cadi Chorrillos' : 'Cedi Ate');
}

/* Mapa Ub√≠came + Sigma */
const SIGMA_CSV_URL = 'https://raw.githubusercontent.com/Gokzarag/RoadMap/main/Catalogo%20Sigma.csv';
let sigmaData = [];
let ubicameMap = null;
let ubicameMapaIniciado = false;
let ubicameMarker = null;

function makeCustomMarker(color){
  const svg=encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="15" height="21" viewBox="0 0 20 29">
      <path d="M10 0C4.5 0 0 4.6 0 10.2 0 18.4 8.8 28.1 9.2 28.6c.4.5 1.2.5 1.6 0C11.2 28.1 20 18.4 20 10.2 20 4.6 15.5 0 10 0zm0 13.5c-2.1 0-3.7-1.7-3.7-3.7S7.9 6 10 6s3.7 1.7 3.7 3.7-1.7 3.8-3.7 3.8z"
        fill="${color}" stroke="#555" stroke-width="1"/>
    </svg>`);
  return L.icon({iconUrl:"data:image/svg+xml,"+svg,iconSize:[15,21],iconAnchor:[7.5,21],popupAnchor:[0,-16]});
}

function makeBlackDotMarker() {
  const size = 10;
  const svg = encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2 - 1}" fill="black" stroke="white" stroke-width="1"/>
    </svg>`
  );
  return L.icon({
    iconUrl: "data:image/svg+xml," + svg,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

function showUserLocationOnMap(enable, mapInstance = ubicameMap) {
  if (!mapInstance) return;
  if (ubicameMarker && ubicameMarker._isUser) {
    mapInstance.removeLayer(ubicameMarker);
    ubicameMarker = null;
  }
  if (enable && "geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      (pos) => {
        const {latitude, longitude} = pos.coords;
        if (ubicameMarker && ubicameMarker._isUser) {
          mapInstance.removeLayer(ubicameMarker);
        }
        const mk = L.marker([latitude, longitude], {
          icon: makeBlackDotMarker(),
          zIndexOffset: 99999
        }).addTo(mapInstance)
          .bindPopup('<div style="font-size:10px;">Mi ubicaci√≥n actual</div>');
        mk._isUser = true;
        ubicameMarker = mk;
      },
      (err) => {},
      { enableHighAccuracy:true, maximumAge:9000, timeout:10000 }
    );
  }
}

/* Buscar en Sigma */
function buscarClienteSigma() {
  const codigo = document.getElementById('codigoClienteInput').value.trim();
  const resultadoDiv = document.getElementById('resultadoCliente');
  
  if (!codigo) {
    resultadoDiv.textContent = 'Ingresa un c√≥digo de cliente v√°lido';
    resultadoDiv.className = 'error';
    resultadoDiv.style.display = 'block';
    return;
  }

  const cliente = sigmaData.find(row => {
    const deudor = (row[0] || '').toString().trim();
    return deudor === codigo;
  });

  if (!cliente) {
    resultadoDiv.textContent = `Cliente ${codigo} no encontrado en cat√°logo Sigma`;
    resultadoDiv.className = 'error';
    resultadoDiv.style.display = 'block';
    if (ubicameMarker && !ubicameMarker._isUser) {
      ubicameMap.removeLayer(ubicameMarker);
      ubicameMarker = null;
    }
    return;
  }

  // Columnas Sigma seg√∫n tu definici√≥n
  const nombre = cliente[7] || 'N/D';       // col 8
  const direccion = cliente[14] || 'N/D';   // col 15
  const distrito = cliente[16] || 'N/D';    // col 17
  const lat = parseFloat(cliente[28]);      // col 29
  const lng = parseFloat(cliente[29]);      // col 30

  if (isNaN(lat) || isNaN(lng)) {
    resultadoDiv.textContent = `Cliente ${codigo} no tiene coordenadas v√°lidas`;
    resultadoDiv.className = 'error';
    resultadoDiv.style.display = 'block';
    return;
  }

  resultadoDiv.innerHTML = `
    <strong>Cliente encontrado:</strong><br>
    C√≥digo: ${codigo}<br>
    Nombre: ${nombre}<br>
    Direcci√≥n: ${direccion}<br>
    Distrito: ${distrito}
  `;
  resultadoDiv.className = 'exito';
  resultadoDiv.style.display = 'block';

  mostrarClienteEnMapa(lat, lng, nombre, direccion, distrito);
}

function mostrarClienteEnMapa(lat, lng, nombre, direccion, distrito) {
  if (!ubicameMap) return;

  if (ubicameMarker && !ubicameMarker._isUser) {
    ubicameMap.removeLayer(ubicameMarker);
  }

  const gmaps = `https://www.google.com/maps?q=${lat},${lng}`;
  const popupContent = `
    <div style="font-size:11px; line-height:1.3; min-width:220px;">
      <div style="font-weight:bold; color:#e95567; margin-bottom:4px;">üìç ${nombre}</div>
      <div style="color:#666; margin-bottom:2px;">üìç ${direccion}</div>
      <div style="color:#666; margin-bottom:6px;">üèõÔ∏è ${distrito}</div>
      <a href="${gmaps}" target="_blank" rel="noopener" style="color:#075985; font-weight:600; font-size:10px;">üó∫Ô∏è Abrir en Google Maps</a>
    </div>
  `;

  const mk = L.marker([lat, lng], {
    icon: makeCustomMarker('#e95567')
  }).bindPopup(popupContent);

  mk.addTo(ubicameMap);
  ubicameMarker = mk;
  ubicameMap.setView([lat, lng], 17);
}

/* Cargar Sigma */
function loadSigmaCSV() {
  Papa.parse(SIGMA_CSV_URL, {
    download: true, header: false, skipEmptyLines: true,
    complete: function(results) {
      sigmaData = results.data;
      // console.log('Cat√°logo Sigma cargado:', sigmaData.length);
    }
  });
}

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  pintarZonaSidebar();

  setTimeout(function(){
    ubicameMap = L.map('ubicame-map').setView([-12.1, -77.0], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(ubicameMap);
    ubicameMapaIniciado = true;
    showUserLocationOnMap(true, ubicameMap);
  }, 60);

  loadSigmaCSV();
});
</script>
</body>
</html>



