<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa Clientes - MapTrack V2.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet y PapaParse -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 950px;
      margin: 0 auto;
      background: #fafcff;
    }
    .header-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 20px 0 10px 0;
    }
    .header-row img {
      height: 38px;
    }
    .fecha-entrega {
      margin-top: 10px;
      font-size: 0.97em;
      color: #555;
      font-weight: bold;
    }
    #map {
      height: 550px;
      width: 98%;
      min-width: 320px;
      min-height: 350px;
      border-radius:8px;
      box-shadow: 2px 2px 18px #e5e9f3c7;
      margin-top: 12px;
    }
    label, select {
      font-size:0.98em;
    }
    h2 {
      font-size: 1.3em;
    }
  </style>
</head>
<body>
  <div class="header-row">
    <img src="https://drive.google.com/thumbnail?id=11yaeiYnsBYXFX46VNs_5ARJ_E8fDBHzw" alt="Logo" />
    <h2>Mapa de Clientes - MapTrack V2.1</h2>
  </div>
  <label for="placa">Placa:</label>
  <select id="placa"></select>
  <label for="cliente">Cliente:</label>
  <select id="cliente"></select>
  <div class="fecha-entrega" id="fechaEntrega"></div>
  <div id="map"></div>
  <script>
    const csv_url = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';

    const COL_PLACA = 'Vehicle Key/Placa';
    const COL_CODIGO_CLIENTE = 'Customer Account # / Cliente';
    const COL_NOMBRE_CLIENTE = 'Customer Name/Solic';
    const COL_ERROR = 'Customer Name2';
    const COL_CITY = 'City';
    const COL_ADDRESS = 'Address';
    const COL_LAT = 'Latitude';
    const COL_LNG = 'Longitude';
    const COL_FECHA = 'Fecha de Entrega';

    let rawData = [];
    let map, markers = [];
    let firstLoad = true;

    function uniqueBy(arr, keys) {
      const seen = {};
      return arr.filter(row => {
        const key = keys.map(k => row[k]).join('|');
        if (seen[key]) return false;
        seen[key] = true;
        return true;
      });
    }

    function createMap(latDefault = -12.1, lngDefault = -77.0) {
      map = L.map('map').setView([latDefault, lngDefault], 12);
      // CartoDB Positron (tipo Google Maps)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://carto.com/" target="_blank">CartoDB</a> &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }).addTo(map);
    }

    function plotMarkers(data) {
      if (markers.length > 0) for (const m of markers) map.removeLayer(m);
      markers = [];
      if (data.length === 0) return;
      let any = false;
      for (const row of data) {
        const lat = parseFloat(row[COL_LAT]);
        const lng = parseFloat(row[COL_LNG]);
        if (!lat || !lng) continue;
        let clienteLabel = row[COL_NOMBRE_CLIENTE];
        const comentario = row[COL_ERROR];
        if (comentario && !['', 'error', '(blank)', '(blanco)', ' '].includes((comentario||"").trim().toLowerCase())) {
          clienteLabel += ` (${comentario})`;
        }
        const linea2 = `${row[COL_ADDRESS]} - ${row[COL_CITY]}`;
        const gmaps = `https://www.google.com/maps?q=${lat},${lng}`;
        // Todo el contenido es un enlace
        const tooltip = `
          <div style="font-size:1em;">
            <a href="${gmaps}" target="_blank" style="color:#2566a8;text-decoration:underline;">
              <span style="font-weight:bold;">${clienteLabel}</span><br>
              <span>${linea2}</span>
            </a>
          </div>
        `;
        const marker = L.marker([lat, lng]).bindTooltip(tooltip, { direction: 'top', sticky: true, opacity:0.97 });
        marker.addTo(map);
        markers.push(marker);
        if (!any) {
          map.setView([lat, lng], 15);
          any = true;
        }
      }
    }

    function filtrarComboClientes(placa) {
      const clientesSet = new Set();
      rawData.filter(row => row[COL_PLACA] === placa)
             .forEach(row => clientesSet.add(row[COL_NOMBRE_CLIENTE]));
      const clientes = Array.from(clientesSet).sort();
      const sel = document.getElementById('cliente');
      sel.innerHTML = '<option value="">Todos</option>' + clientes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function filtrarYRenderizar() {
      const placaSel = document.getElementById('placa').value;
      const clienteSel = document.getElementById('cliente').value;
      let data = rawData.filter(row => row[COL_PLACA] === placaSel);
      if (clienteSel) data = data.filter(row => row[COL_NOMBRE_CLIENTE] === clienteSel);
      data = uniqueBy(data, [COL_PLACA, COL_CODIGO_CLIENTE]);
      plotMarkers(data);
      let fecha = '';
      if (data.length > 0) fecha = data[0][COL_FECHA];
      document.getElementById('fechaEntrega').textContent = fecha ? ('Fecha de entrega: ' + fecha) : '';
    }

    Papa.parse(csv_url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        rawData = results.data.filter(row =>
          row[COL_PLACA] && row[COL_CODIGO_CLIENTE] && row[COL_LAT] && row[COL_LNG] &&
          !isNaN(parseFloat(row[COL_LAT])) &&
          !isNaN(parseFloat(row[COL_LNG]))
        );
        const placas = [...new Set(rawData.map(row => row[COL_PLACA]))];
        const sel = document.getElementById('placa');
        sel.innerHTML = placas.map((p, i) => `<option value="${p}"${i===0?' selected':''}>${p}</option>`).join('');
        filtrarComboClientes(placas[0]);
        if (rawData.length > 0) {
          let fechaTexto = rawData[COL_FECHA] ? ('Fecha de entrega: ' + rawData[COL_FECHA]) : '';
          document.getElementById('fechaEntrega').textContent = fechaTexto;
        }
        if (firstLoad) {
          createMap();
          filtrarYRenderizar();
          firstLoad = false;
        }
      }
    });

    document.getElementById('placa').addEventListener('change', function(e) {
      filtrarComboClientes(e.target.value);
      filtrarYRenderizar();
    });

    document.getElementById('cliente').addEventListener('change', filtrarYRenderizar);

  </script>
</body>
</html>