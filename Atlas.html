<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MapTrack - Atlas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --color-primary: #0756a1;
      --color-primary-light: #1a7ed6;
      --color-accent: #e95567;
      --color-accent-light: #ff7b86;
      --color-bg-light: #f8fafc;
      --color-bg-lighter: #f6fafe;
      --color-bg-input: #ffffff;
      --color-border-light: #cde7f7;
      --color-text-primary: #222222;
      --color-text-secondary: #403535;
      --color-success: #095c2a;
      --color-error: #b33;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --font-size-header: 11px;
      --font-size-table: 9.8px;
      --font-size-body: 10.5px;
      --font-size-small: 9px;
      --font-size-smaller: 8.5px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: var(--font-family);
      font-size: var(--font-size-body);
      background: var(--color-bg-light);
      color: var(--color-text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }
    a {
      color: var(--color-primary);
      text-decoration: none;
      transition: color 0.2s ease;
      font-size: inherit;
    }
    a:hover, a:focus {
      color: var(--color-primary-light);
      outline: none;
      text-decoration: underline;
    }
    /* Header */
    .header-row {
      position: sticky;
      top: 0;
      z-index: 1050;
      display: flex;
      align-items: center;
      gap: 7px;
      background: #e8f3fb;
      border-bottom: 2px solid var(--color-border-light);
      height: 38px;
      padding: 0 6px;
      font-size: var(--font-size-header);
      font-weight: 600;
      color: var(--color-primary);
      box-shadow: 0 2px 6px rgba(3, 91, 124, 0.12);
      overflow-x: auto;
      flex-wrap: nowrap;
      -webkit-overflow-scrolling: touch;
    }
    .header-row::-webkit-scrollbar { display: none; }
    .header-logo {
      width: 23px;
      height: 23px;
      border-radius: 50%;
      border: 1px solid var(--color-border-light);
      flex-shrink: 0;
      margin-right: 2px;
    }
    .zona-switch-row {
      display: flex;
      align-items: center;
      gap: 3px;
      user-select: none;
      flex-shrink: 0;
      white-space: nowrap;
      font-size: var(--font-size-header);
    }
    .zona-switch-row label[for="zonaSwitch"] {
      cursor: pointer;
      font-size: var(--font-size-header);
      font-weight: 500;
      color: var(--color-primary);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 24px;
      height: 11px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .switch input {
      opacity: 0; width: 0; height: 0;
      pointer-events: none;
    }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 12px;
      border: 1px solid #bbb;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.6);
    }
    .slider:before {
      position: absolute; content: "";
      height: 8px; width: 8px; left:2px; bottom:1px;
      background: white; transition: .4s; border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.13);
    }
    input:checked + .slider {
      background-color: var(--color-primary);
      border-color: var(--color-primary-light);
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.9);
    }
    input:checked + .slider:before { transform: translateX(12px);}
    #zonaIdentificador {
      font-weight: 700;
      font-size: var(--font-size-header);
      min-width: 60px;
      margin-left: 2px;
      color: var(--color-success);
      user-select: text;
      letter-spacing: 0.01em;
      line-height: 1.0;
      transition: color 0.3s ease;
      white-space: nowrap;
      padding: 1px 3px;
      border-radius: 10px;
      background: #d0f0d9;
      box-shadow: inset 0 0 2px rgb(9 92 42 / 0.30);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #zonaIdentificador.inactive {
      color: var(--color-error);
      background: #fddddd;
      box-shadow: inset 0 0 2px rgb(179 51 51 / 0.30);
    }
    .header-spacer { flex-grow: 0; min-width: 2px;}
    .fecha-entrega {
      font-size: var(--font-size-header);
      font-weight: 700;
      color: var(--color-text-primary);
      margin-left: auto;
      user-select: none;
      padding: 2px 6px;
      background: #e0f0ff;
      border-radius: 10px;
      min-width: 45px;
      text-align: center;
      box-shadow: 0 0 3px rgba(3,91,124,0.10);
      letter-spacing: 0.04em;
      font-family: monospace;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .telegram-link {
      display: flex; align-items: center;
      text-decoration: none;
      transition: filter 0.2s ease;
      flex-shrink: 0;
      padding: 1.5px;
      border-radius: 4px;
      margin-left: 4px;
    }
    .telegram-link:hover,
    .telegram-link:focus {
      filter: brightness(1.12);
      outline: 1px solid var(--color-primary-light);
    }
    .telegram-icon {
      width: 16px;
      height: 16px;
      display: block;
      filter: drop-shadow(0 0 1.5px #018cc7);
      flex-shrink: 0;
    }
    /* Main Area */
    .main-area {
      display: flex;
      height: calc(100vh - 38px);
      background: var(--color-bg-light);
      overflow: hidden;
      user-select: text;
      font-size: var(--font-size-body);
    }
    /* Tabs vertical */
    .tabs-vertical {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 52px;
      background: var(--color-bg-lighter);
      border-right: 1.2px solid var(--color-border-light);
      padding-top: 5px;
      font-family: var(--font-family);
      font-size: var(--font-size-smaller);
    }
    .tab-btn {
      padding: 5px 8px 5px 10px;
      border: none;
      border-radius: 6px 0 0 6px;
      background: transparent;
      color: var(--color-primary);
      font-size: 11.5px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.13s, color 0.22s;
      text-align: left;
      outline-offset: 2px;
      box-shadow: 0 1px 2px rgb(0 0 0 / 0.04);
      line-height: 1.2;
    }
    .tab-btn:hover,
    .tab-btn:focus {
      background: var(--color-primary-light);
      color: white;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.09);
    }
    .tab-btn.active {
      background: white;
      color: var(--color-accent);
      border-right: 3px solid var(--color-accent);
      font-weight: 700;
      cursor: default;
      user-select: none;
    }
    .tabs-content-main {
      flex-grow: 1;
      padding: 8px 9px 7px 10px;
      background: white;
      overflow-y: auto;
      border-radius: 0 7px 7px 0;
      box-shadow: inset 0 0 8px #dde7f1;
      font-size: var(--font-size-body);
    }
    .tab-content { display: none; height: 100%;}
    .tab-content.active { display: block; height: 100%;}

    /* Filters Mapa */
    .filters-mapa {
      display: flex;
      gap: 6px;
      margin-bottom: 7px;
      align-items: center;
      background: var(--color-bg-lighter);
      border-radius: 6px;
      padding: 4px 7px;
      border: 1px solid var(--color-border-light);
      font-family: var(--font-family);
      font-size: var(--font-size-small);
      font-weight: 600;
      color: var(--color-text-secondary);
      user-select: none;
    }
    .filters-mapa label {
      font-weight: 700;
      color: var(--color-primary);
      user-select: none;
      white-space: nowrap;
      font-size: var(--font-size-small);
    }
    .filters-mapa select {
      padding: 3px 6px;
      border: 1.5px solid #bbd7ff;
      border-radius: 6px;
      background: var(--color-bg-input);
      min-width: 60px;
      font-size: var(--font-size-small);
      transition: border-color 0.25s ease;
      font-weight: 600;
      color: var(--color-text-primary);
      cursor: pointer;
      outline-offset: 2px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .filters-mapa select:focus {
      border-color: var(--color-accent);
      outline: none;
    }

    #map {
      width: 100%;
      height: 97vh;
      min-height: 180px;
      max-height: 98vh;
      border-radius: 7px;
      border: 1.2px solid var(--color-border-light);
      margin-top: 7px;
      background: #e9f6fb55;
      box-sizing: border-box;
      user-select: none;
      box-shadow: 0 0 10px rgba(3,91,124,0.08);
      font-size: var(--font-size-small);
    }

    /* Buscador */
    .buscador-container {
      display: flex;
      align-items: center;
      max-width: 180px;
      gap: 3px;
      margin-bottom: 7px;
      user-select: none;
    }
    .search-box {
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--color-bg-input);
      border: 1px solid #a4c5f9;
      border-radius: 7px;
      overflow: hidden;
      box-shadow: inset 0 0 3px #b5d2ff44;
    }
    .search-box input {
      flex-grow: 1;
      font-size: var(--font-size-small);
      padding: 3px 5px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--color-text-primary);
      font-weight: 500;
      font-family: var(--font-family);
      user-select: text;
    }
    .search-box input::placeholder {
      color: #999;
      font-weight: 400;
      font-size: var(--font-size-small);
    }
    .search-box button {
      font-size: var(--font-size-small);
      padding: 3px 6px;
      color: white;
      background: linear-gradient(135deg, var(--color-accent-light), var(--color-accent));
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-left: 1px solid #d3545d;
      border-radius: 0 7px 7px 0;
      box-shadow: 0 2px 2px rgba(0,0,0,0.06);
    }
    .search-box button:hover,
    .search-box button:focus {
      background: linear-gradient(135deg, #f44f63, #e2414e);
      outline: none;
      box-shadow: 0 2px 6px rgba(228,85,103,0.14);
    }
    /* Agenda Table & Scroll */
    .agenda-scroll-x {
      overflow-x: auto;
      max-width: 100%;
      box-shadow: inset 0 0 2px #a5bde258;
      border-radius: 7px;
      background: white;
      box-sizing: border-box;
      user-select: text;
    }
    table {
      border-collapse: separate;
      border-spacing: 0 2px;
      margin: 0 auto;
      width: auto;
      max-width: 100%;
      font-size: var(--font-size-table);
      border-radius: 7px;
      background: white;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.06);
      user-select: text;
      table-layout: auto;
      min-width: 120px;
    }
    th, td {
      text-align: left;
      padding: 4px 6px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      max-width: none;
      vertical-align: middle;
      border: none;
    }
    th {
      background: var(--color-accent-light);
      color: white;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      border-top-left-radius: 7px;
      border-top-right-radius: 7px;
      font-size: var(--font-size-small);
      box-shadow: 0 1px 2px rgb(0 0 0 / 0.09);
    }
    tbody tr:hover {
      background: #ffe4e9;
      box-shadow: inset 0 0 3px #e9556780;
      border-radius: 4px;
    }
    tr.resaltado {
      background: #fbe7e9 !important;
      font-weight: 700;
      color: var(--color-accent);
      box-shadow: inset 0 0 6px #e9556780 !important;
      border-radius: 4px;
    }
    /* Responsive */
    @media (max-width: 860px) {
      .main-area { flex-direction: column; height: auto; font-size: var(--font-size-small);}
      .tabs-vertical { flex-direction: row; min-width: auto; font-size: var(--font-size-smaller);}
      .tab-btn { border-radius: 6px 6px 0 0; font-size: var(--font-size-small); padding: 6px 10px;}
      .tabs-content-main { padding: 7px 7px 7px 7px;}
      #map { height: 60vh !important; }
    }
    @media (max-width: 480px) {
      .tab-btn {font-size: 8px;}
      .filters-mapa { font-size: 7.8px;}
      #map { height: 42vh !important;}
      table { font-size: 7.5px; }
      th, td { padding: 2.5px 3px;}
      .buscador-container { gap: 1.5px; }
      .search-box button, .search-box input {
        font-size: 7.7px;
        padding: 2.5px 5.5px;
      }
      .header-row { font-size: 8px; height: 32px; padding: 0 3px;}
      .fecha-entrega { min-width: 40px; padding: 1.4px 3.7px; font-size: 7.5px; }
      #zonaIdentificador { font-size: 7.5px; min-width: 38px; padding: 1px 2px;}
      .header-logo { width: 15px; height: 15px;}
      .telegram-icon { width: 11px; height: 11px;}
      .switch { width: 16px; height: 7px;}
      .slider:before { height: 5px; width: 5px; left: 1.2px; bottom: 0.7px;}
.documentos-lista {
  margin: 28px 0 0 4px;
  padding: 0 0 0 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.documento-link {
  display: flex;
  align-items: center;
  gap: 7px;
  color: var(--color-primary);
  font-size: 11.5px;
  font-weight: 600;
  text-decoration: none;
  padding: 4px 0;
  transition: color 0.13s;
}
.documento-link:hover,
.documento-link:focus {
  color: var(--color-accent);
  text-decoration: underline;
}
.pdf-icon {
  width: 19px;
  height: 19px;
  display: inline-block;
  vertical-align: middle;
  margin-right: 1px;
  filter: drop-shadow(0 0 1.5px #fc3641d9);
}
    }
  </style>
</head>
<body>
  <div class="header-row" role="banner">
    <img src="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" alt="Logo MapTrack" class="header-logo" />
    <div class="zona-switch-row">
      <label for="zonaSwitch">Zona:</label>
      <label class="switch">
        <input type="checkbox" id="zonaSwitch" checked />
        <span class="slider round"></span>
      </label>
      <span id="zonaIdentificador">Cadi Chorrillos</span>
    </div>
    <span class="fecha-entrega" id="fecha-entrega"></span>
    <span class="header-spacer"></span>
    <a href="https://t.me/MapTrack_bot" target="_blank" rel="noopener noreferrer" class="telegram-link">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram" class="telegram-icon" />
    </a>
  </div>
  <div class="main-area">
    <nav class="tabs-vertical">
      <button class="tab-btn active" id="btnAgenda" onclick="switchTab('agenda')">Agenda</button>
      <button class="tab-btn" id="btnDocumentos" onclick="switchTab('documentos')">Documentos</button>
      <button class="tab-btn" id="btnMapa" onclick="switchTab('mapa')">Planos</button>
      
    </nav>
    <main class="tabs-content-main">
      <section id="tab-agenda" class="tab-content active">
        <div class="buscador-container">
          <div class="search-box">
            <input type="text" id="buscador-principal" placeholder="Buscar en agenda..." oninput="onGlobalSearchInput()" autocomplete="off" spellcheck="false" />
            <button type="button" onclick="nuevaBusqueda()">Nueva</button>
          </div>
        </div>
        <div class="agenda-scroll-x">
          <table id="agenda-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Solicitante</th>
                <th>Ruta<br>Venta</th>
                <th>Placa</th>
                <th>Asignación</th>
                <th>Teléfono</th>
                <th>Dirección</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section id="tab-mapa" class="tab-content">
        <div class="filters-mapa">
          <label for="placa">Placa:</label>
          <select id="placa"></select>
          <label for="cliente">Cliente:</label>
          <select id="cliente"></select>
        </div>
        <div id="map"></div>
      </section>
      <section id="tab-documentos" class="tab-content">
  	<div class="documentos-lista">
    	  <a class="documento-link" href="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/BRAEDT-SCTR%20SALUD.pdf" target="_blank">
          <svg class="pdf-icon" viewBox="0 0 24 24" style="width:19px;height:19px;"><path fill="#e95567" d="M6.5 2A2.5 2.5 0 0 0 4 4.5v15A2.5 2.5 0 0 0 6.5 22h11a2.5 2.5 0 0 0 2.5-2.5V7l-5-5Zm.5 2h7.5V8a1 1 0 0 0 1 1H20v11.5a.5.5 0 0 1-.5.5h-15a.5.5 0 0 1-.5-.5v-15A.5.5 0 0 1 6.5 2Zm8.5 2.21L18.79 8H16a.5.5 0 0 1-.5-.5Zm-9 12.04h2.74c.64 0 1.13-.13 1.47-.39.34-.26.51-.68.51-1.27 0-.53-.15-.96-.45-1.27-.31-.32-.8-.48-1.51-.48h-1.26v-1.36h2.38v-.9h-3.39v5.67Zm.94-.86V14.5h1.14c.43 0 .75.09.96.27.22.18.33.45.33.8s-.1.62-.29.81c-.19.19-.52.28-.98.28Zm5.05-2.57c-.41.23-.74.57-.95 1.02-.22.45-.33 1.03-.33 1.75 0 .69.11 1.25.33 1.7.21.44.54.79.95 1.03.42.24.91.36 1.5.36.84 0 1.5-.2 1.9-.6.41-.39.62-.95.62-1.66 0-.72-.21-1.27-.62-1.67-.4-.39-1.07-.58-1.84-.58-.56 0-1.04.12-1.45.35Zm.29 2.05c0-.5.09-.89.26-1.15.18-.27.48-.4.91-.4.43 0 .73.14.91.41.17.27.26.65.26 1.14 0 .51-.09.9-.27 1.16-.17.25-.48.38-.9.38-.44 0-.74-.13-.91-.39-.18-.26-.26-.65-.26-1.15Zm4.44-1.91v3.55h.94v-3.56h1.46v-.87h-3.87v.87Z"/></svg>
      SCTR Salud
    </a>
<br>
<br>
    <a class="documento-link" href="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/BRAEDT-SCTR%20SALUD.pdf" target="_blank">
      <svg class="pdf-icon" viewBox="0 0 24 24" style="width:19px;height:19px;"><path fill="#e95567" d="M6.5 2A2.5 2.5 0 0 0 4 4.5v15A2.5 2.5 0 0 0 6.5 22h11a2.5 2.5 0 0 0 2.5-2.5V7l-5-5Zm.5 2h7.5V8a1 1 0 0 0 1 1H20v11.5a.5.5 0 0 1-.5.5h-15a.5.5 0 0 1-.5-.5v-15A.5.5 0 0 1 6.5 2Zm8.5 2.21L18.79 8H16a.5.5 0 0 1-.5-.5Zm-9 12.04h2.74c.64 0 1.13-.13 1.47-.39.34-.26.51-.68.51-1.27 0-.53-.15-.96-.45-1.27-.31-.32-.8-.48-1.51-.48h-1.26v-1.36h2.38v-.9h-3.39v5.67Zm.94-.86V14.5h1.14c.43 0 .75.09.96.27.22.18.33.45.33.8s-.1.62-.29.81c-.19.19-.52.28-.98.28Zm5.05-2.57c-.41.23-.74.57-.95 1.02-.22.45-.33 1.03-.33 1.75 0 .69.11 1.25.33 1.7.21.44.54.79.95 1.03.42.24.91.36 1.5.36.84 0 1.5-.2 1.9-.6.41-.39.62-.95.62-1.66 0-.72-.21-1.27-.62-1.67-.4-.39-1.07-.58-1.84-.58-.56 0-1.04.12-1.45.35Zm.29 2.05c0-.5.09-.89.26-1.15.18-.27.48-.4.91-.4.43 0 .73.14.91.41.17.27.26.65.26 1.14 0 .51-.09.9-.27 1.16-.17.25-.48.38-.9.38-.44 0-.74-.13-.91-.39-.18-.26-.26-.65-.26-1.15Zm4.44-1.91v3.55h.94v-3.56h1.46v-.87h-3.87v.87Z"/></svg>
      SCTR Pensión
    </a>
  </div>
</section>
    </main>
  </div>
<script>
const CSV_URL = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';
let rawData=[], dataRowsRaw=[], dataRows=[];
let buscadorGlobal = '';
const COL_PLACA = 'Vehicle Key/Placa', COL_CODIGO_CLIENTE = 'Customer Account # / Cliente',
      COL_NOMBRE_CLIENTE = 'Customer Name/Solic', COL_ERROR = 'Customer Name2',
      COL_CITY = 'City', COL_ADDRESS = 'Address', COL_FECHA = 'Fecha de Entrega',
      COL_CONSIDERA = 'Considera', COL_LAT = 'Latitude', COL_LNG = 'Longitude';
// Geolocation marker variable for the user
let userLocationMarker = null;
let userLocationWatchId = null;

function toDDMMYYYY(fechaStr) {
  if (!fechaStr) return '';
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaStr.trim())) {
    let [a,m,d]=fechaStr.trim().split('-'); return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
  }
  let sep = fechaStr.includes('/') ? '/' : '-';
  let [p1,p2,p3] = fechaStr.trim().split(sep);
  if (p3 && p3.length===4){let d=parseInt(p1),m=parseInt(p2),y=parseInt(p3); if(m>12)[d,m]=[m,d];
    return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;}
  return fechaStr;
}
function actualizarIdentificadorZona(){
  const chk = document.getElementById("zonaSwitch");
  const txt = chk.checked ? "Cadi Chorrillos" : "Cedí Ate";
  const el = document.getElementById("zonaIdentificador");
  el.textContent = txt;
  if(chk.checked){
    el.style.color = "#095";
    el.classList.remove('inactive');
  } else {
    el.style.color = "#b33";
    el.classList.add('inactive');
  }
}
function showEntrega(fecha) {
  document.getElementById("fecha-entrega").textContent = fecha || "";
}
let map, mapaIniciado = false, markers=[];
function getColorForString(str,total) {
  let hash=0;
  for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash);}
  const hue=Math.abs(hash)%total;
  return `hsl(${Math.round(hue*(360/total))},75%,49%)`;
}
function makeCustomMarker(color){
  const svg=encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="15" height="21" viewBox="0 0 20 29"><path d="M10 0C4.5 0 0 4.6 0 10.2 0 18.4 8.8 28.1 9.2 28.6c.4.5 1.2.5 1.6 0C11.2 28.1 20 18.4 20 10.2 20 4.6 15.5 0 10 0zm0 13.5c-2.1 0-3.7-1.7-3.7-3.7S7.9 6 10 6s3.7 1.7 3.7 3.7-1.7 3.8-3.7 3.8z" fill="${color}" stroke="#555" stroke-width="1"/></svg>`);
  return L.icon({iconUrl:"data:image/svg+xml,"+svg,iconSize:[15,21],iconAnchor:[7.5,21],popupAnchor:[0,-16]});
}
function makeBlackDotMarker() {
  // Size: 10x10 px, centered, proportional to Leaflet's 15x21 locator
  const size = 10;
  const svg = encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2 - 1}" fill="black" stroke="white" stroke-width="1"/>
    </svg>`
  );
  return L.icon({
    iconUrl: "data:image/svg+xml," + svg,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}
function showUserLocationOnMap(enable) {
  if (!map) return;
  // Remove previous user marker if exists
  if (userLocationMarker) {
    map.removeLayer(userLocationMarker);
    userLocationMarker = null;
  }
  if (userLocationWatchId !== null) {
    navigator.geolocation.clearWatch(userLocationWatchId);
    userLocationWatchId = null;
  }
  if (enable && "geolocation" in navigator) {
    userLocationWatchId = navigator.geolocation.watchPosition(
      (pos) => {
        const {latitude, longitude} = pos.coords;
        if (!userLocationMarker) {
          userLocationMarker = L.marker([latitude, longitude], {
            icon: makeBlackDotMarker(),
            zIndexOffset: 99999
          }).addTo(map)
            .bindPopup('<div style="font-size:10px;">Mi ubicación actual</div>');
        } else {
          userLocationMarker.setLatLng([latitude, longitude]);
        }
      },
      (err) => {},
      { enableHighAccuracy:true, maximumAge:9000, timeout:10000 }
    );
  }
}
function getVisited() {
  try{ return JSON.parse(localStorage.getItem('visitedPoints_MapTrack')||'{}') }catch{return {}}
}
function setVisited(obj){ localStorage.setItem('visitedPoints_MapTrack',JSON.stringify(obj)) }
function getUniqueId(row){ return `${row[COL_PLACA]}|${row[COL_CODIGO_CLIENTE]}` }
function uniqueBy(arr,keys){
  const seen={}; return arr.filter(row=>{ const key=keys.map(k=>row[k]).join('|'); if(seen[key]) return false; seen[key]=true; return true; });
}
function plotMarkers(data){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  let bounds = [];
  const clientes=[...new Set(data.map(r=>r[COL_NOMBRE_CLIENTE]))];
  const colores={};
  clientes.forEach((c,i)=>{colores[c]=getColorForString(c,clientes.length+2)});
  const visited=getVisited();
  data.forEach(row=>{
    const lat=parseFloat(row[COL_LAT]),lng=parseFloat(row[COL_LNG]);
    if(!lat||!lng) return;
    bounds.push([lat, lng]);
    let cliente=row[COL_NOMBRE_CLIENTE];
    const com=row[COL_ERROR];
    if(com&&!(["","error","(blank)","(blanco)"].includes(com.trim().toLowerCase())))
      cliente+=` (${com})`;
    const gmaps=`https://www.google.com/maps?q=${lat},${lng}`;
    const pointId=getUniqueId(row);
    const checked=visited[pointId]?"checked":"";
    const color=visited[pointId]?"#fff":colores[row[COL_NOMBRE_CLIENTE]];
    const popup=`<div style="font-size:10px; line-height:1.25;"><a href="${gmaps}" target="_blank" rel="noopener" style="color:${colores[row[COL_NOMBRE_CLIENTE]]};font-weight:bold;">${cliente}</a><br>${row[COL_ADDRESS]} - ${row[COL_CITY]}<br><label style="font-size:0.85em; cursor:pointer;"><input type="checkbox" id="v_${pointId}" ${checked} /> Visitado</label></div>`;
    const mk=L.marker([lat,lng],{icon:makeCustomMarker(color)}).bindPopup(popup);
    mk.on("popupopen",()=>{
      const cb=document.getElementById("v_"+pointId);
      if(cb) cb.addEventListener("change",()=>{
        let v=getVisited();
        if(cb.checked){v[pointId]=true;}else delete v[pointId];
        setVisited(v);
        mk.setIcon(makeCustomMarker(cb.checked?"#fff":colores[row[COL_NOMBRE_CLIENTE]]));
      });
    });
    mk.addTo(map);
    markers.push(mk);
  });
  setTimeout(()=>{
    if(bounds.length > 0) {
      if(bounds.length === 1){
        map.setView(bounds[0], 17);
      } else {
        const limit = L.latLngBounds(bounds);
        map.fitBounds(limit.pad(0.24));
      }
    }
  }, 140);
}
function filtrarClientes(placa, consideraFilter){
  const set=new Set();
  rawData.filter(r=>{
    if(consideraFilter){
      if(r[COL_CONSIDERA] !== consideraFilter) return false;
    } else {
      if(r[COL_CONSIDERA] === "0752") return false;
    }
    return r[COL_PLACA]===placa;
  }).forEach(r=>set.add(r[COL_NOMBRE_CLIENTE]));
  const sel=document.getElementById("cliente");
  sel.innerHTML='<option value="">Todos</option>'+[...set].sort().map(c=>`<option>${c}</option>`).join('');
}
function filtrar(){
  const consideraFilter = document.getElementById("zonaSwitch").checked ? "0752" : null;
  let placa=document.getElementById("placa").value, cliente=document.getElementById("cliente").value;
  let data=rawData.filter(r=>{
    if(consideraFilter){
      if(r[COL_CONSIDERA] !== consideraFilter) return false;
    } else {
      if(r[COL_CONSIDERA] === "0752") return false;
    }
    return r[COL_PLACA] === placa;
  });
  if(cliente) data=data.filter(r=>r[COL_NOMBRE_CLIENTE]===cliente);
  data=uniqueBy(data,[COL_PLACA,COL_CODIGO_CLIENTE]);
  plotMarkers(data);
  let fecha=data.length?toDDMMYYYY(data[0][COL_FECHA]):"";
  showEntrega(fecha);
}
function filtrarZonaYRender() {
  const zonaChecked = document.getElementById('zonaSwitch').checked;
  if(zonaChecked) {
    dataRows = getUnique(dataRowsRaw.filter(r => r.Considera && r.Considera.trim() === '0752'));
  } else {
    dataRows = getUnique(dataRowsRaw.filter(r => r.Considera && r.Considera.trim() !== '0752'));
  }
  mostrarFechaEntrega(dataRows);
  renderTable();
  actualizarIdentificadorZona();
  if(mapaIniciado) cargarFiltrosMapa();
}
function getUnique(arr) {
  const seen = new Set();
  return arr.filter(row => {
    const key = [
      row.Cliente, row.Solicitante, row.RutaVenta,
      row.Placa, row.Asignacion, row.Telefono, row.Direccion
    ].join('|').toLowerCase();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}
function mostrarFechaEntrega(rows) {
  let fechas = [...new Set(rows.map(r => r.FechaEntrega).filter(f => f))];
  fechas.sort((a, b) => {
    let [da, ma, aa] = a.split('/').map(Number), [db, mb, ab] = b.split('/').map(Number);
    let dA = new Date(aa, ma - 1, da), dB = new Date(ab, mb - 1, db);
    return dA - dB;
  });
  let fechaMostrar = fechas.length ? fechas[0] : '';
  let textoFecha = fechaMostrar ? fechaMostrar : '';
  document.getElementById('fecha-entrega').textContent = textoFecha;
}
function renderTable() {
  let tbody = document.querySelector('#agenda-table tbody');
  let fragment = document.createDocumentFragment();
  let rowsShow = dataRows.filter(row => match(row));
  for (let i = 0; i < rowsShow.length && i < 250; i++) {
    let row = rowsShow[i];
    let tr = document.createElement('tr');
    tr.innerHTML = `
        <td title="${row.Cliente}">${row.Cliente}</td>
        <td title="${row.Solicitante}">${row.Solicitante}</td>
        <td title="${row.RutaVenta}">${row.RutaVenta}</td>
        <td title="${row.Placa}">${row.Placa}</td>
        <td title="${row.Asignacion}">${row.Asignacion}</td>
        <td title="${row.Telefono}">${row.Telefono}</td>
        <td title="${row.Direccion.replace(/<.*?>/g,'')}">${row.Direccion}</td>
    `;
    tr.addEventListener('touchstart', ()=> tr.classList.add('resaltado'));
    tr.addEventListener('touchend', ()=> setTimeout(()=>tr.classList.remove('resaltado'),120));
    fragment.appendChild(tr);
  }
  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}
function match(row) {
  if (buscadorGlobal && buscadorGlobal !== '') {
    let val = [
      row.Cliente, row.Solicitante, row.RutaVenta, row.Placa,
      row.Asignacion, row.Telefono, row.Direccion, row.Pedido
    ].join(' ').toLowerCase();
    if (!val.includes(buscadorGlobal)) return false;
  }
  return true;
}
window.onGlobalSearchInput = function () {
  buscadorGlobal = document.getElementById('buscador-principal').value.trim().toLowerCase();
  renderTable();
};
window.nuevaBusqueda = function () {
  buscadorGlobal = '';
  document.getElementById('buscador-principal').value = '';
  renderTable();
};
document.getElementById('zonaSwitch').addEventListener('change', filtrarZonaYRender);
window.switchTab = function(tab) {
  let tabMap = document.getElementById('tab-mapa');
  let tabAgenda = document.getElementById('tab-agenda');
  let tabDocumentos = document.getElementById('tab-documentos');
  let btnMapa = document.getElementById('btnMapa');
  let btnAgenda = document.getElementById('btnAgenda');
  let btnDocumentos = document.getElementById('btnDocumentos');
  [tabMap, tabAgenda, tabDocumentos].forEach(x => x.classList.remove('active'));
  [btnMapa, btnAgenda, btnDocumentos].forEach(x => x.classList.remove('active'));
  [tabMap, tabAgenda, tabDocumentos].forEach(x => x.setAttribute('aria-hidden','true'));
  [btnMapa, btnAgenda, btnDocumentos].forEach(x => x.setAttribute('aria-selected','false'));
  [btnMapa, btnAgenda, btnDocumentos].forEach(x => x.tabIndex=-1);

  if(tab==='mapa'){
    tabMap.classList.add('active'); tabMap.setAttribute('aria-hidden','false');
    btnMapa.classList.add('active'); btnMapa.setAttribute('aria-selected','true'); btnMapa.tabIndex=0; tabMap.focus();
    if(typeof map==="undefined" || !mapaIniciado) {
      setTimeout(function(){
        map = L.map('map').setView([-12.1,-77.0],12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {maxZoom:19,attribution:'&copy; OpenStreetMap'}
        ).addTo(map);
        mapaIniciado = true;
        cargarFiltrosMapa();
        showUserLocationOnMap(true);
      },60);
    } else {
      setTimeout(()=>{ map.invalidateSize(); }, 100);
      showUserLocationOnMap(true);
    }
  }
  else if(tab==='agenda'){
    tabAgenda.classList.add('active'); tabAgenda.setAttribute('aria-hidden','false');
    btnAgenda.classList.add('active'); btnAgenda.setAttribute('aria-selected','true'); btnAgenda.tabIndex=0; tabAgenda.focus();
    showUserLocationOnMap(false);
  }
  else if(tab==='documentos'){
    tabDocumentos.classList.add('active'); tabDocumentos.setAttribute('aria-hidden','false');
    btnDocumentos.classList.add('active'); btnDocumentos.setAttribute('aria-selected','true'); btnDocumentos.tabIndex=0; tabDocumentos.focus();
    showUserLocationOnMap(false);
  }
};
// Se llama tras cargar mapa o cambiar pestañas
function cargarFiltrosMapa(){
  const consideraFilter = document.getElementById("zonaSwitch").checked ? "0752" : null;
  const placas = [...new Set(rawData.filter(r=>{
    if(consideraFilter) return r[COL_CONSIDERA] === consideraFilter;
    return r[COL_CONSIDERA] !== "0752";
  }).map(r=>r[COL_PLACA]))];
  document.getElementById("placa").innerHTML=placas.map((p,i)=>`<option ${i==0?"selected":""}>${p}</option>`).join('');
  filtrarClientes(placas[0], consideraFilter);
  filtrar();
}
function loadCSV() {
  Papa.parse(CSV_URL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function (results) {
      rawData=results.data.filter(row=>
        row[COL_PLACA] && row[COL_CODIGO_CLIENTE] && row[COL_LAT] && row[COL_LNG]
        && !isNaN(parseFloat(row[COL_LAT])) && !isNaN(parseFloat(row[COL_LNG]))
      );
      const rows = results.data;
      dataRowsRaw = rows.map(row => {
        let E = row[COL_NOMBRE_CLIENTE]||'';
        let F = row[COL_ERROR]||'';
        let fullSolic = (F && !['0', '#N/A', '(blank)', '', ' '].includes(F)) ? `${E} - ${F}` : E;
        let address = row[COL_ADDRESS]||'';
        let city = row[COL_CITY]||'';
        let dirCity = address + (city ? ' - ' + city : '');
        let lat = row[COL_LAT]||'';
        let lng = row[COL_LNG]||'';
        let mapLink = (lat && lng) ? `<a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" rel="noopener">${dirCity}</a>` : dirCity;
        let fecha = toDDMMYYYY(row[COL_FECHA]||'');
        let asignacion = row['Asignación']||row['Asignacion']||'';
        let telefono = row['Teléfono']||row['Telefono']||row['Phone']||'';
        return {
          raw: row,
          Cliente: row[COL_CODIGO_CLIENTE]||'',
          Solicitante: fullSolic,
          RutaVenta: row['RUTA VENTA']||row['Ruta Venta']||'',
          Placa: row[COL_PLACA]||'',
          Asignacion: asignacion,
          Telefono: telefono,
          Direccion: mapLink,
          FechaEntrega: fecha,
          Pedido: row['#Pedido'] || row['Pedido'] || '',
          Considera: row[COL_CONSIDERA]||''
        };
      });
      filtrarZonaYRender();
    }
  });
}
document.getElementById("placa").addEventListener("change", ()=>{
  const consideraFilter = document.getElementById("zonaSwitch").checked ? "0752" : null;
  filtrarClientes(document.getElementById("placa").value, consideraFilter);
  filtrar();
});
document.getElementById("cliente").addEventListener("change", filtrar);
document.addEventListener('DOMContentLoaded', ()=>{ loadCSV(); });
</script>
</body>
</html>



