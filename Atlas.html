<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MapTrack - Atlas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" />
  <meta name="theme-color" content="#e8f3fb"/>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f8fafc; }
    .header-row {
      display: flex; align-items: center; gap: 8px; background: #e8f3fb; border-bottom: 1px solid #cde7f7;
      height: 44px; padding: 0 8px; position: sticky; top: 0; z-index: 999; font-size: 0.97em;
    }
    .header-logo { width: 23px; height: 23px; border-radius: 50%; border: 1px solid #cceeff; }
    .zona-switch-row { display: flex; align-items: center; gap: 5px; }
    .switch { position: relative; display: inline-block; width: 28px; height: 15px;}
    .switch input { opacity: 0; width: 0; height: 0;}
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 12px;}
    .slider:before { position: absolute; content: ""; height: 11px; width: 11px; left:2px; bottom:2px;
      background: white; transition: .4s; border-radius: 50%;}
    input:checked + .slider { background-color: #2196F3;}
    input:checked + .slider:before {transform: translateX(13px);}
    #zonaIdentificador {font-weight: bold; font-size: 1em; min-width: 94px; margin-left: 3px; color: #095;}
    .fecha-entrega {font-size: 0.99em; color: #222; font-weight: 600;}
    .agenda-menu { display: flex; margin-top: 7px; align-items: flex-end; gap: 6px; }
    .tab-btn {
      padding: 7px 15px 6px 15px; border: none; border-radius: 7px 7px 0 0;
      background: #f9f9f9; color: #e95567; font-weight: bold; font-size: 15px;
      cursor: pointer; transition: background 0.15s, color 0.17s;
      border-bottom: 3px solid transparent;
      outline: none;
    }
    .tab-btn.inactive { color: #036; font-weight: 500; background: #f4f6fc; }
    .tab-btn.active { background: #fff; border-bottom: 3px solid #e95567;}
    .btn-nueva { margin-left: auto; background: #ffeef4; color: #e95567; font-weight: 700;
      border:1px solid #fdc2d3; border-radius: 6px; padding: 5px 18px; font-size: 13px; cursor: pointer; }
    .btn-nueva:hover { background: #fff2fa; color: #f01762; }
    .buscador-container { display: flex; align-items: center; max-width: 420px; gap: 5px; margin-bottom: 8px;}
    .search-box { display: flex; align-items: center; background: #fff; border: 1.2px solid #c8c8e3; border-radius: 7px; overflow: hidden; width: 100%; }
    .search-box input { flex: 1; font-size: 12.5px; padding: 6px 7px; border: none; outline: none; background: transparent;}
    .search-box button { font-size: 12.5px; padding: 6px 12px; color: white; background: linear-gradient(135deg,#ff6c80,#e95567); border: none; cursor: pointer; font-weight: 600; border-left: 1px solid #ddd; border-radius: 0 7px 7px 0;}
    .agenda-scroll-x { overflow-x: auto; margin-top: 0; width: 100%; }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 520px;
      background: #fff;
      border-radius: 7px;
      font-size: 14px;
      box-shadow: 0 2px 8px #e9f5fc16;
      margin-bottom: 9px;
    }
    th, td {
      text-align: left;
      padding: 7px 4px 7px 4px;
      word-break: break-word;
      white-space: pre-line;
      border-bottom: 1px solid #ebdde6;
      max-width: 160px;
      vertical-align: top;
    }
    th {
      background: #facfd6;
      color: #403535;
      font-weight: 700;
      font-size: 14.2px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:nth-child(even) td { background: #f7fbfc; }
    tr:hover td { background: #fff2f7 !important;}
    tr.resaltado td { background: #ffd5ea !important;}
    td a {
      color: #0a77d9;
      font-weight: 600;
      word-break: break-all;
      text-decoration: underline;
      font-size: 13.6px;
    }
    @media (max-width: 800px) {
      table, th, td {
        font-size: 12.4px;
        max-width: 96px;
        padding: 6px 2.5px 6px 2.5px;
      }
      .agenda-menu { gap: 3px; }
      .btn-nueva { font-size: 12px; padding: 4px 10px;}
    }
    @media (max-width: 520px) {
      th, td { font-size: 10.7px; max-width: 68px; padding: 3px 1px;}
      .btn-nueva { font-size: 10.5px; padding: 3.8px 5px;}
      .tab-btn { font-size: 13px; padding: 6px 6px 6px 6px;}
      .search-box input,.search-box button {font-size:10px;}
      td a { font-size: 10.8px;}
    }
  </style>
</head>
<body>
  <div class="header-row">
    <img src="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" class="header-logo">
    <div class="zona-switch-row">
      <label for="zonaSwitch" style="color:#036;font-weight:500;">Zona:</label>
      <label class="switch">
        <input type="checkbox" id="zonaSwitch" checked>
        <span class="slider round"></span>
      </label>
      <span id="zonaIdentificador">Cadi Chorrillos</span>
    </div>
    <span class="fecha-entrega" id="fecha-entrega"></span>
  </div>
  <div class="agenda-menu">
    <button class="tab-btn active" id="btnAgenda">Agenda</button>
    <button class="tab-btn inactive" id="btnMapa">Planos</button>
    <button class="btn-nueva" onclick="nuevaBusqueda()">Nueva</button>
  </div>
  <div class="buscador-container">
    <div class="search-box">
      <input type="text" id="buscador-principal" placeholder="Buscar en agenda..." oninput="onGlobalSearchInput()"/>
      <button onclick="nuevaBusqueda()">Nueva</button>
    </div>
  </div>
  <div class="agenda-scroll-x">
    <table id="agenda-table">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Solicitante</th>
          <th>Ruta Venta</th>
          <th>Placa</th>
          <th>Asignación</th>
          <th>Teléfono</th>
          <th>Dirección</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';
let dataRows=[];
let buscadorGlobal = '';
function toDDMMYYYY(fechaStr) {
  if (!fechaStr) return '';
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaStr.trim())) {
    let [a,m,d]=fechaStr.trim().split('-'); return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
  }
  let sep = fechaStr.includes('/') ? '/' : '-';
  let [p1,p2,p3] = fechaStr.trim().split(sep);
  if (p3 && p3.length===4){let d=parseInt(p1),m=parseInt(p2),y=parseInt(p3); if(m>12)[d,m]=[m,d];
    return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;}
  return fechaStr;
}
function match(row) {
  if (buscadorGlobal && buscadorGlobal !== '') {
    let val = [
      row.Cliente, row.Solicitante, row.RutaVenta, row.Placa,
      row.Asignacion, row.Telefono, row.Direccion, row.Pedido
    ].join(' ').toLowerCase();
    if (!val.includes(buscadorGlobal)) return false;
  }
  return true;
}
window.onGlobalSearchInput = function () {
  buscadorGlobal = document.getElementById('buscador-principal').value.trim().toLowerCase();
  renderTable();
};
window.nuevaBusqueda = function () {
  buscadorGlobal = '';
  document.getElementById('buscador-principal').value = '';
  renderTable();
};
function renderTable() {
  let tbody = document.querySelector('#agenda-table tbody');
  let fragment = document.createDocumentFragment();
  let rowsShow = dataRows.filter(row => match(row));
  for (let i = 0; i < rowsShow.length && i < 400; i++) {
    let row = rowsShow[i];
    let tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${row.Cliente}</td>
        <td>${row.Solicitante}</td>
        <td>${row.RutaVenta}</td>
        <td>${row.Placa}</td>
        <td>${row.Asignacion}</td>
        <td>${row.Telefono}</td>
        <td>${row.Direccion}</td>
    `;
    tr.addEventListener('touchstart', ()=> tr.classList.add('resaltado'));
    tr.addEventListener('touchend', ()=> setTimeout(()=>tr.classList.remove('resaltado'),120));
    fragment.appendChild(tr);
  }
  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}
function loadCSV() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function (results) {
      const rows = results.data;
      function safe(col, row) {
        return row[col]!==undefined?(row[col]+''||''):'';
      }
      dataRows = rows.map(row => {
        let address = safe('Address', row) || '';
        let city    = safe('City', row) || '';
        let dirCity = address + (city ? ' - ' + city : '');
        let lat = safe('Latitude', row);
        let lng = safe('Longitude', row);
        let mapLink = (lat && lng) ? `<a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank">${dirCity}</a>` : dirCity;
        return {
          Cliente: safe('Customer Account # / Cliente', row),
          Solicitante: safe('Customer Name/Solic', row),
          RutaVenta: safe('RUTA VENTA', row) || safe('Ruta Venta', row),
          Placa: safe('Vehicle Key/Placa', row),
          Asignacion: safe('Asignación', row) || safe('Asignacion', row),
          Telefono: safe('Teléfono', row) || safe('Telefono', row) || safe('Phone', row),
          Direccion: mapLink,
          Pedido: safe('#Pedido', row) || safe('Pedido', row)
        };
      });
      renderTable();
      // Actualiza header con fecha
      let fecha = toDDMMYYYY(rows[0]['Fecha de Entrega'] || '');
      document.getElementById('fecha-entrega').textContent = fecha ? "Entrega: " + fecha : '';
    }
  });
}
document.addEventListener('DOMContentLoaded', ()=>{ loadCSV(); });
</script>
</body>
</html>
