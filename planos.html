<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RoadMap - Planos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="https://raw.githubusercontent.com/Gokzarag/RoadMap/main/MapTrack.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --sidebar-bg:#1f2933;
      --sidebar-accent:#f9735b;
      --sidebar-accent-soft:#fde3dd;
      --sidebar-text:#f9fafb;
      --sidebar-muted:#9ca3af;
      --main-bg:#f4f5f7;
      --card-bg:#ffffff;
      --border-soft:#e5e7eb;
      --text-main:#111827;
      --text-muted:#6b7280;
      --font:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:var(--font);
      background:var(--main-bg);
      color:var(--text-main);
      min-height:100vh;
      margin:0;
    }
    .layout{
      display:flex;
      width:100%;
      min-height:100vh;
    }
    /* SIDEBAR */
    .sidebar{
      width:235px;
      background:linear-gradient(180deg,#111827,#1f2933);
      color:var(--sidebar-text);
      display:flex;
      flex-direction:column;
      padding:14px 14px 16px;
      position:sticky;
      top:0;
      height:100vh;
    }
    .sb-header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:18px;
    }
    .sb-logo{
      width:32px;height:32px;border-radius:50%;
      border:1px solid rgba(249,250,251,0.3);
      box-shadow:0 0 12px rgba(249,115,91,0.7);
    }
    .sb-title{
      display:flex;
      flex-direction:column;
    }
    .sb-title span:nth-child(1){
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--sidebar-muted);
    }
    .sb-title span:nth-child(2){
      font-size:15px;
      font-weight:700;
    }
    .sb-section-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--sidebar-muted);
      margin:12px 0 6px;
    }
    .zona-toggle{
      background:rgba(15,23,42,0.9);
      border-radius:8px;
      padding:8px 9px;
      border:1px solid rgba(249,250,251,0.06);
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11.5px;
    }
    .zona-toggle-header{
      display:flex;align-items:center;justify-content:space-between;
      color:var(--sidebar-muted);
    }
    .zona-options{
      display:flex;
      gap:6px;
    }
    .zona-pill{
      flex:1;
      border-radius:999px;
      padding:5px 6px;
      text-align:center;
      font-size:11px;
      cursor:pointer;
      border:1px solid rgba(249,250,251,0.16);
      color:var(--sidebar-muted);
      background:rgba(15,23,42,0.8);
      transition:all .2s;
    }
    .zona-pill.active{
      background:var(--sidebar-accent);
      color:#111827;
      border-color:var(--sidebar-accent-soft);
      box-shadow:0 0 0 1px rgba(254,202,202,0.3);
      font-weight:600;
    }
    .menu{
      margin-top:10px;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .menu a{
      display:flex;
      align-items:center;
      gap:8px;
      padding:7px 8px;
      color:var(--sidebar-text);
      text-decoration:none;
      border-radius:7px;
      border:1px solid transparent;
      transition:background .18s,border-color .18s,transform .12s;
      font-size:13px;
    }
    .menu a span.icon{
      font-size:15px;width:18px;text-align:center;
    }
    .menu a:hover{
      background:rgba(31,41,55,0.9);
      border-color:rgba(249,250,251,0.08);
      transform:translateX(1px);
    }
    .menu a.primary{
      background:rgba(17,24,39,0.95);
      border-color:rgba(249,250,251,0.14);
    }
    .sb-footer{
      margin-top:auto;
      font-size:11px;
      color:var(--sidebar-muted);
      border-top:1px solid rgba(55,65,81,0.9);
      padding-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .sb-footer a{
      color:var(--sidebar-accent-soft);
      text-decoration:none;
      font-size:12px;
    }
    .sb-footer a:hover{text-decoration:underline;}

    /* MAIN */
    .main{
      flex:1;
      padding:14px 16px 16px;
      overflow:auto;
    }
    .panel{
      background:var(--card-bg);
      border-radius:14px;
      padding:10px 12px 12px;
      border:1px solid var(--border-soft);
      box-shadow:0 8px 28px rgba(15,23,42,0.12);
      display:flex;
      flex-direction:column;
      gap:8px;
      height:calc(100vh - 32px);
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel-title h1{
      font-size:16px;
      margin-bottom:2px;
    }
    .panel-title p{
      font-size:12px;
      color:var(--text-muted);
    }
    .panel-meta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:3px;
      font-size:11px;
    }
    .badge-zona-main{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:var(--sidebar-accent-soft);
      color:#7c2d12;
      border:1px solid #fed7c2;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-fecha{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:#e5f3ff;
      color:#1d4ed8;
      border:1px solid #bfdbfe;
      font-family:monospace;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:12px;
    }
    .filters-row label{
      font-weight:600;
      color:var(--text-muted);
    }
    .filters-row select{
      padding:4px 7px;
      border-radius:7px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      font-size:12px;
      min-width:110px;
    }
    .map-wrapper{
      flex:1;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border-soft);
      background:#e5e7eb;
      box-shadow:inset 0 0 6px rgba(15,23,42,0.18);
    }
    #map{
      width:100%;
      height:100%;
      min-height:320px;
    }

    /* RESPONSIVO M√ìVIL */
    @media(max-width:900px){
      .layout{
        flex-direction:column;
      }
      .sidebar{
        width:100%;
        height:auto;
        position:relative;
        flex-direction:row;
        align-items:center;
        justify-content:space-between;
        padding:8px 10px;
        gap:8px;
      }
      .sb-header{
        margin-bottom:0;
      }
      .sb-title span:nth-child(2){
        font-size:13px;
      }
      .sb-section-label{
        display:none;
      }
      .zona-toggle{
        flex-direction:row;
        align-items:center;
        padding:6px 7px;
      }
      .zona-toggle-header{
        display:none;
      }
      .zona-options{
        gap:4px;
      }
      .zona-pill{
        padding:4px 6px;
        font-size:10px;
      }
      .menu{
        flex-direction:row;
        flex-wrap:wrap;
        margin-top:0;
        gap:4px;
      }
      .menu a{
        padding:4px 6px;
        font-size:11px;
      }
      .sb-footer{
        display:none;
      }
      .main{
        padding:10px 8px 12px;
      }
      .panel{
        height:auto;
        min-height:calc(100vh - 70px);
      }
      #map{
        min-height:55vh;
        height:55vh;
      }
      .panel-meta{
        align-items:flex-start;
      }
    }
    @media(max-width:480px){
      .menu a span.icon{display:none;}
      .menu a span{font-size:10px;}
      .zona-pill{
        font-size:9px;
      }
      .panel-title h1{
        font-size:15px;
      }
    }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="sb-header">
      <img src="https://raw.githubusercontent.com/Gokzarag/RoadMap/main/MapTrack.png" class="sb-logo" alt="MapTrack" />
      <div class="sb-title">
        <span>RoadMap</span>
        <span>Distribution Platform</span>
      </div>
    </div>

    <div class="sb-section-label">Oficina</div>
    <div class="zona-toggle">
      <div class="zona-toggle-header">
        <span>Selecciona zona activa</span>
      </div>
      <div class="zona-options">
        <button class="zona-pill" id="zona-ate" onclick="setZona('ATE')">Cedi Ate</button>
        <button class="zona-pill" id="zona-chorr" onclick="setZona('0752')">Cadi Chorrillos</button>
      </div>
    </div>

    <div class="sb-section-label">M√≥dulos</div>
    <ul class="menu">
      <li><a href="index.html"><span class="icon">üè†</span><span>Inicio</span></a></li>
      <li><a href="agenda.html"><span class="icon">üìã</span><span>Agenda</span></a></li>
      <li><a href="planos.html" class="primary"><span class="icon">üó∫Ô∏è</span><span>Planos</span></a></li>
      <li><a href="ubicame.html"><span class="icon">üìç</span><span>Ub√≠came</span></a></li>
      <li><a href="documentos.html"><span class="icon">üìë</span><span>Documentos</span></a></li>
    </ul>

    <div class="sb-footer">
      <span>v2.1</span>
      <a href="https://t.me/MapTrack_bot" target="_blank" rel="noopener">Telegram Bot</a>
    </div>
  </aside>

  <main class="main">
    <section class="panel">
      <header class="panel-header">
        <div class="panel-title">
          <h1>Planos de clientes</h1>
          <p>Filtra por placa y cliente para ver los puntos de entrega y marcar visitas realizadas.</p>
        </div>
        <div class="panel-meta">
          <span class="badge-zona-main">Zona: <strong id="badge-zona-text">-</strong></span>
          <span class="badge-fecha" id="fecha-entrega-badge">--/--/----</span>
        </div>
      </header>

      <div class="filters-row">
        <label for="placa">Placa:</label>
        <select id="placa"></select>

        <label for="cliente">Cliente:</label>
        <select id="cliente"></select>
      </div>

      <div class="map-wrapper">
        <div id="map"></div>
      </div>
    </section>
  </main>
</div>

<script>
/* Zona compartida (localStorage) */
function setZona(z){
  localStorage.setItem('maptrack_zona', z);
  pintarZonaSidebar();
  if (window.filtrarZonaYMapa) {
    window.filtrarZonaYMapa();
  }
}
function getZona(){
  return localStorage.getItem('maptrack_zona') || '0752';
}
function pintarZonaSidebar(){
  const z = getZona();
  const ate = document.getElementById('zona-ate');
  const ch = document.getElementById('zona-chorr');
  if (!ate || !ch) return;
  ate.classList.toggle('active', z !== '0752');
  ch.classList.toggle('active', z === '0752');
  const badge = document.getElementById('badge-zona-text');
  if (badge) badge.textContent = (z === '0752' ? 'Cadi Chorrillos' : 'Cedi Ate');
}

/* --- L√ìGICA MAPA --- */
const CSV_URL = 'https://raw.githubusercontent.com/Gokzarag/RoadMap/main/MapTrack_V2.1.csv';
let rawData = [];
let map, mapaIniciado = false, markers = [];
let ubicameMarker = null;

const COL_PLACA = 'Vehicle Key/Placa',
      COL_CODIGO_CLIENTE = 'Customer Account # / Cliente',
      COL_NOMBRE_CLIENTE = 'Customer Name/Solic',
      COL_ERROR = 'Customer Name2',
      COL_CITY = 'City',
      COL_ADDRESS = 'Address',
      COL_FECHA = 'Fecha de Entrega',
      COL_CONSIDERA = 'Considera',
      COL_LAT = 'Latitude',
      COL_LNG = 'Longitude';

function toDDMMYYYY(fechaStr) {
  if (!fechaStr) return '';
  if (/^d{4}-d{1,2}-d{1,2}$/.test(fechaStr.trim())) {
    let [a,m,d]=fechaStr.trim().split('-');
    return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
  }
  let sep = fechaStr.includes('/') ? '/' : '-';
  let [p1,p2,p3] = fechaStr.trim().split(sep);
  if (p3 && p3.length===4){
    let d=parseInt(p1),m=parseInt(p2),y=parseInt(p3);
    if(m>12)[d,m]=[m,d];
    return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;
  }
  return fechaStr;
}

function showEntrega(fecha) {
  document.getElementById("fecha-entrega-badge").textContent = fecha || "--/--/----";
}

function makeBlackDotMarker() {
  const size = 10;
  const svg = encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2 - 1}" fill="black" stroke="white" stroke-width="1"/>
    </svg>`
  );
  return L.icon({
    iconUrl: "data:image/svg+xml," + svg,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

function showUserLocationOnMap(enable, mapInstance = map) {
  if (!mapInstance) return;
  if (ubicameMarker) {
    mapInstance.removeLayer(ubicameMarker);
    ubicameMarker = null;
  }
  if (enable && "geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      (pos) => {
        const {latitude, longitude} = pos.coords;
        if (ubicameMarker) {
          mapInstance.removeLayer(ubicameMarker);
        }
        ubicameMarker = L.marker([latitude, longitude], {
          icon: makeBlackDotMarker(),
          zIndexOffset: 99999
        }).addTo(mapInstance)
          .bindPopup('<div style="font-size:10px;">Mi ubicaci√≥n actual</div>');
      },
      (err) => {},
      { enableHighAccuracy:true, maximumAge:9000, timeout:10000 }
    );
  }
}

function getVisited() {
  try{ return JSON.parse(localStorage.getItem('visitedPoints_MapTrack')||'{}') }catch{return {}}
}
function setVisited(obj){ localStorage.setItem('visitedPoints_MapTrack',JSON.stringify(obj)) }
function getUniqueId(row){ return `${row[COL_PLACA]}|${row[COL_CODIGO_CLIENTE]}` }

function getColorForString(str,total) {
  let hash=0;
  for(let i=0;i<str.length;i++){ hash=str.charCodeAt(i)+((hash<<5)-hash);}
  const hue=Math.abs(hash)%total;
  return `hsl(${Math.round(hue*(360/total))},75%,49%)`;
}

function makeCustomMarker(color){
  const svg=encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="15" height="21" viewBox="0 0 20 29"><path d="M10 0C4.5 0 0 4.6 0 10.2 0 18.4 8.8 28.1 9.2 28.6c.4.5 1.2.5 1.6 0C11.2 28.1 20 18.4 20 10.2 20 4.6 15.5 0 10 0zm0 13.5c-2.1 0-3.7-1.7-3.7-3.7S7.9 6 10 6s3.7 1.7 3.7 3.7-1.7 3.8-3.7 3.8z" fill="${color}" stroke="#555" stroke-width="1"/></svg>`);
  return L.icon({iconUrl:"data:image/svg+xml,"+svg,iconSize:[15,21],iconAnchor:[7.5,21],popupAnchor:[0,-16]});
}

function uniqueBy(arr,keys){
  const seen={};
  return arr.filter(row=>{
    const key=keys.map(k=>row[k]).join('|');
    if(seen[key]) return false;
    seen[key]=true;
    return true;
  });
}

function plotMarkers(data){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  let bounds = [];
  const clientes=[...new Set(data.map(r=>r[COL_NOMBRE_CLIENTE]))];
  const colores={};
  clientes.forEach((c,i)=>{colores[c]=getColorForString(c,clientes.length+2)});
  const visited=getVisited();
  data.forEach(row=>{
    const lat=parseFloat(row[COL_LAT]),lng=parseFloat(row[COL_LNG]);
    if(!lat||!lng) return;
    bounds.push([lat, lng]);
    let cliente=row[COL_NOMBRE_CLIENTE];
    const com=row[COL_ERROR];
    if(com&&!(["","error","(blank)","(blanco)"].includes(com.trim().toLowerCase())))
      cliente+=` (${com})`;
    const gmaps=`https://www.google.com/maps?q=${lat},${lng}`;
    const pointId=getUniqueId(row);
    const checked=visited[pointId]?"checked":"";
    const color=visited[pointId]?"#fff":colores[row[COL_NOMBRE_CLIENTE]];
    const popup=`<div style="font-size:10px; line-height:1.25;">
      <a href="${gmaps}" target="_blank" rel="noopener" style="color:${colores[row[COL_NOMBRE_CLIENTE]]};font-weight:bold;">${cliente}</a><br>
      ${row[COL_ADDRESS]} - ${row[COL_CITY]}<br>
      <label style="font-size:0.85em; cursor:pointer;"><input type="checkbox" id="v_${pointId}" ${checked} /> Visitado</label>
    </div>`;
    const mk=L.marker([lat,lng],{icon:makeCustomMarker(color)}).bindPopup(popup);
    mk.on("popupopen",()=>{
      const cb=document.getElementById("v_"+pointId);
      if(cb) cb.addEventListener("change",()=>{
        let v=getVisited();
        if(cb.checked){v[pointId]=true;}else delete v[pointId];
        setVisited(v);
        mk.setIcon(makeCustomMarker(cb.checked?"#fff":colores[row[COL_NOMBRE_CLIENTE]]));
      });
    });
    mk.addTo(map);
    markers.push(mk);
  });
  setTimeout(()=>{
    if(bounds.length > 0) {
      if(bounds.length === 1){
        map.setView(bounds[0], 17);
      } else {
        const limit = L.latLngBounds(bounds);
        map.fitBounds(limit.pad(0.24));
      }
    }
  }, 140);
}

function filtrarClientes(placa, zona){
  const set=new Set();
  rawData.filter(r=>{
    if(zona === '0752'){
      if(r[COL_CONSIDERA] !== '0752') return false;
    } else {
      if(r[COL_CONSIDERA] === '0752') return false;
    }
    return r[COL_PLACA]===placa;
  }).forEach(r=>set.add(r[COL_NOMBRE_CLIENTE]));
  const sel=document.getElementById("cliente");
  sel.innerHTML='<option value="">Todos</option>'+[...set].sort().map(c=>`<option>${c}</option>`).join('');
}

function filtrar(){
  const zona = getZona();
  let placa=document.getElementById("placa").value,
      cliente=document.getElementById("cliente").value;
  let data=rawData.filter(r=>{
    if(zona === '0752'){
      if(r[COL_CONSIDERA] !== '0752') return false;
    } else {
      if(r[COL_CONSIDERA] === '0752') return false;
    }
    return r[COL_PLACA] === placa;
  });
  if(cliente) data=data.filter(r=>r[COL_NOMBRE_CLIENTE]===cliente);
  data=uniqueBy(data,[COL_PLACA,COL_CODIGO_CLIENTE]);
  plotMarkers(data);
  let fecha=data.length?toDDMMYYYY(data[0][COL_FECHA]):"";
  showEntrega(fecha);
}

function cargarFiltrosMapa(){
  const zona = getZona();
  const placas = [...new Set(rawData.filter(r=>{
    if(zona === '0752') return r[COL_CONSIDERA] === '0752';
    return r[COL_CONSIDERA] !== "0752";
  }).map(r=>r[COL_PLACA]))];
  const placaSel = document.getElementById("placa");
  if (!placas.length){
    placaSel.innerHTML = '<option value="">(Sin datos)</option>';
    document.getElementById("cliente").innerHTML = '<option value="">Todos</option>';
    plotMarkers([]);
    showEntrega('');
    return;
  }
  placaSel.innerHTML=placas.map((p,i)=>`<option ${i==0?"selected":""}>${p}</option>`).join('');
  filtrarClientes(placas[0], zona);
  filtrar();
}

function loadCSV() {
  Papa.parse(CSV_URL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function (results) {
      rawData=results.data.filter(row=>
        row[COL_PLACA] && row[COL_CODIGO_CLIENTE] && row[COL_LAT] && row[COL_LNG]
        && !isNaN(parseFloat(row[COL_LAT])) && !isNaN(parseFloat(row[COL_LNG]))
      );
      cargarFiltrosMapa();
    }
  });
}

/* Inicializaci√≥n */
document.addEventListener('DOMContentLoaded', ()=>{
  pintarZonaSidebar();
  setTimeout(function(){
    map = L.map('map').setView([-12.1,-77.0],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {maxZoom:19,attribution:'&copy; OpenStreetMap'}
    ).addTo(map);
    mapaIniciado = true;
    showUserLocationOnMap(true);
  },60);
  loadCSV();
});

/* API para setZona */
window.filtrarZonaYMapa = function(){
  pintarZonaSidebar();
  cargarFiltrosMapa();
};

/* Listeners filtros */
document.getElementById("placa").addEventListener("change", ()=>{
  const zona = getZona();
  filtrarClientes(document.getElementById("placa").value, zona);
  filtrar();
});
document.getElementById("cliente").addEventListener("change", filtrar);
</script>
</body>
</html>
