<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MapTrack - Planos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: sans-serif; background: #f7faff;
    }
    body {
      display: flex; flex-direction: column; max-width: 1200px; margin: auto;
    }
    /* === BARRA SUPERIOR ESTILO APP === */
    .header-row {
      position: fixed; top: 0; left: 0; right: 0;
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; padding: 4px 8px;
      background: #e9f5fb;
      border-bottom: 1px solid #cde7f7;
      height: 42px;
      z-index: 9999;
    }
    .header-left {
      display: flex; align-items: center; gap: 8px;
    }
    .header-row img {
      width: 30px; height: 30px; border-radius: 50%; border: 1px solid #cceeff;
    }
    .filtros-row { display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.85em; align-items: center; }
    label { font-weight: 500; color: #036; font-size: 0.85em; }
    select {
      padding: 2px 4px; font-size: 0.85em;
      border: 1px solid #bcd9ff; border-radius: 4px;
      background: #fff; cursor: pointer;
    }
    .fecha-entrega {
      font-size: 0.75em; color: #000; font-weight: 500;
      white-space: nowrap; margin-left: auto;
    }
    #map {
      flex: 1;
      border: 1px solid #d2ebf7;
      border-radius: 8px;
      margin: 46px 4px 4px 4px; /* deja espacio para la barra fija */
      min-height: calc(100vh - 60px);
    }
    @media (max-width:600px){
      .header-row { flex-direction: column; align-items: flex-start; height: auto; padding: 6px; gap: 4px; }
      #map { margin-top: 70px; }
    }
    /* Switch button styles */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    #zonaIdentificador {
      font-weight: bold;
      margin-right: 8px;
      margin-left: 2px;
      font-size: 1em;
      color: #095;
      min-width: 110px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="header-row">
    <div class="header-left">
      <img src="https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack.png" alt="Logo" />
      <div class="filtros-row">
        <label for="consideraSwitch">Zona:</label>
        <label class="switch">
          <input type="checkbox" id="consideraSwitch" checked />
          <span class="slider round"></span>
        </label>
        <span id="zonaIdentificador">Cadi Chorrillos</span>
        <label for="placa">Placa:</label><select id="placa"></select>
        <label for="cliente">Cliente:</label><select id="cliente"></select>
      </div>
    </div>
    <div class="fecha-entrega" id="fechaEntrega"></div>
  </div>

  <div id="map"></div>

  <script>
    // === VARIABLES DE DATOS ===
    const csv_url = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';
    const COL_PLACA = 'Vehicle Key/Placa';
    const COL_CODIGO_CLIENTE = 'Customer Account # / Cliente';
    const COL_NOMBRE_CLIENTE = 'Customer Name/Solic';
    const COL_ERROR = 'Customer Name2';
    const COL_CITY = 'City';
    const COL_ADDRESS = 'Address';
    const COL_LAT = 'Latitude';
    const COL_LNG = 'Longitude';
    const COL_FECHA = 'Fecha de Entrega';
    const COL_CONSIDERA = 'Considera';

    function toDDMMYYYY(fechaStr) {
      if (!fechaStr) return '';
      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaStr.trim())) {
        let [a,m,d]=fechaStr.trim().split('-'); return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
      }
      let sep = fechaStr.includes('/') ? '/' : '-';
      let [p1,p2,p3] = fechaStr.trim().split(sep);
      if (p3 && p3.length===4){let d=parseInt(p1),m=parseInt(p2),y=parseInt(p3); if(m>12)[d,m]=[m,d];
        return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;}
      return fechaStr;
    }

    function getColorForString(str,total){
      let hash=0;
      for(let i=0;i<str.length;i++){
        hash=str.charCodeAt(i)+((hash<<5)-hash);
      }
      const hue=Math.abs(hash)%total;
      return `hsl(${Math.round(hue*(360/total))},75%,49%)`;
    }

    function makeCustomMarker(color){
      const svg=encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="22" height="30" viewBox="0 0 20 29"><path d="M10 0C4.5 0 0 4.6 0 10.2 0 18.4 8.8 28.1 9.2 28.6c.4.5 1.2.5 1.6 0C11.2 28.1 20 18.4 20 10.2 20 4.6 15.5 0 10 0zm0 13.5c-2.1 0-3.7-1.7-3.7-3.7S7.9 6 10 6s3.7 1.7 3.7 3.7-1.7 3.8-3.7 3.8z" fill="${color}" stroke="#555" stroke-width="1"/></svg>`);
      return L.icon({iconUrl:"data:image/svg+xml,"+svg,iconSize:[22,30],iconAnchor:[11,30],popupAnchor:[0,-25]});
    }

    function getVisited(){
      try{
        return JSON.parse(localStorage.getItem('visitedPoints_MapTrack')||'{}')
      }catch{
        return {}
      }
    }

    function setVisited(obj){
      localStorage.setItem('visitedPoints_MapTrack',JSON.stringify(obj))
    }

    function getUniqueId(row){
      return `${row[COL_PLACA]}|${row[COL_CODIGO_CLIENTE]}`
    }

    let rawData=[],
        map,
        markers=[];

    function uniqueBy(arr,keys){
      const seen={};
      return arr.filter(row=>{
        const key=keys.map(k=>row[k]).join('|');
        if(seen[key]) return false;
        seen[key]=true;
        return true;
      });
    }

    function createMap(){
      map=L.map('map').setView([-12.1,-77.0],12);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);
    }

    function plotMarkers(data){
      markers.forEach(m=>map.removeLayer(m));
      markers=[];
      const clientes=[...new Set(data.map(r=>r[COL_NOMBRE_CLIENTE]))];
      const colores={};
      clientes.forEach((c,i)=>{colores[c]=getColorForString(c,clientes.length+2)});
      const visited=getVisited();
      data.forEach(row=>{
        const lat=parseFloat(row[COL_LAT]),lng=parseFloat(row[COL_LNG]);
        if(!lat||!lng) return;
        let cliente=row[COL_NOMBRE_CLIENTE];
        const com=row[COL_ERROR];
        if(com&&!(["","error","(blank)","(blanco)"].includes(com.trim().toLowerCase()))) cliente+=` (${com})`;
        const gmaps=`https://www.google.com/maps?q=${lat},${lng}`;
        const pointId=getUniqueId(row);
        const checked=visited[pointId]?"checked":"";
        const color=visited[pointId]?"#fff":colores[row[COL_NOMBRE_CLIENTE]];
        const popup=`<div><a href="${gmaps}" target="_blank" style="color:${colores[row[COL_NOMBRE_CLIENTE]]};font-weight:bold;">${cliente}</a><br>${row[COL_ADDRESS]} - ${row[COL_CITY]}<br><label><input type="checkbox" id="v_${pointId}" ${checked}> Visitado</label></div>`;
        const mk=L.marker([lat,lng],{icon:makeCustomMarker(color)}).bindPopup(popup);
        mk.on("popupopen",()=>{
          const cb=document.getElementById("v_"+pointId);
          if(cb) cb.addEventListener("change",()=>{
            let v=getVisited();
            if(cb.checked){v[pointId]=true;}else delete v[pointId];
            setVisited(v);
            mk.setIcon(makeCustomMarker(cb.checked?"#fff":colores[row[COL_NOMBRE_CLIENTE]]));
          });
        });
        mk.addTo(map);
        markers.push(mk);
      });
    }

    function filtrarClientes(placa){
      const consideraFilter = document.getElementById("consideraSwitch").checked ? "0752" : null;
      const set=new Set();
      rawData.filter(r=>{
        if(consideraFilter){
          if(r[COL_CONSIDERA] !== consideraFilter) return false;
        } else {
          if(r[COL_CONSIDERA] === "0752") return false;
        }
        return r[COL_PLACA]===placa;
      }).forEach(r=>set.add(r[COL_NOMBRE_CLIENTE]));
      const sel=document.getElementById("cliente");
      sel.innerHTML='<option value="">Todos</option>'+[...set].sort().map(c=>`<option>${c}</option>`).join('');
    }

    function filtrar(){
      const consideraFilter = document.getElementById("consideraSwitch").checked ? "0752" : null;
      let placa=document.getElementById("placa").value, cliente=document.getElementById("cliente").value;
      let data=rawData.filter(r=>{
        if(consideraFilter){
          if(r[COL_CONSIDERA] !== consideraFilter) return false;
        } else {
          if(r[COL_CONSIDERA] === "0752") return false;
        }
        return r[COL_PLACA] === placa;
      });
      if(cliente) data=data.filter(r=>r[COL_NOMBRE_CLIENTE]===cliente);
      data=uniqueBy(data,[COL_PLACA,COL_CODIGO_CLIENTE]);
      plotMarkers(data);
      let fecha=data.length?toDDMMYYYY(data[0][COL_FECHA]):"";
      document.getElementById("fechaEntrega").textContent=fecha?("Entrega: "+fecha):"";
    }

    function actualizarIdentificadorZona(){
      const chk = document.getElementById("consideraSwitch");
      const txt = chk.checked ? "Cadi Chorrillos" : "Cedí Ate";
      const color = chk.checked ? "#095" : "#b33";
      document.getElementById("zonaIdentificador").textContent = txt;
      document.getElementById("zonaIdentificador").style.color = color;
    }

    Papa.parse(csv_url,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:r=>{
        rawData=r.data.filter(row=>
          row[COL_PLACA] && row[COL_CODIGO_CLIENTE] && row[COL_LAT] && row[COL_LNG]
          && !isNaN(parseFloat(row[COL_LAT])) && !isNaN(parseFloat(row[COL_LNG]))
        );
        const consideraFilter = document.getElementById("consideraSwitch").checked ? "0752" : null;
        const placas = [...new Set(rawData.filter(r=>{
          if(consideraFilter) return r[COL_CONSIDERA] === consideraFilter;
          return r[COL_CONSIDERA] !== "0752";
        }).map(r=>r[COL_PLACA]))];
        document.getElementById("placa").innerHTML=placas.map((p,i)=>`<option ${i==0?"selected":""}>${p}</option>`).join('');
        filtrarClientes(placas[0]);
        createMap();
        filtrar();
        actualizarIdentificadorZona();
      }
    });

    document.getElementById("placa").addEventListener("change",()=>{filtrarClientes(document.getElementById("placa").value);filtrar()});
    document.getElementById("cliente").addEventListener("change",filtrar);
    document.getElementById("consideraSwitch").addEventListener("change", ()=>{
      actualizarIdentificadorZona();
      const consideraFilter = document.getElementById("consideraSwitch").checked ? "0752" : null;
      const placas = [...new Set(rawData.filter(r=>{
        if(consideraFilter) return r[COL_CONSIDERA] === consideraFilter;
        return r[COL_CONSIDERA] !== "0752";
      }).map(r=>r[COL_PLACA]))];
      const placaSel = document.getElementById("placa");
      placaSel.innerHTML=placas.map((p,i)=>`<option ${i==0?"selected":""}>${p}</option>`).join('');
      filtrarClientes(placas[0]);
      filtrar();
    });

    // === UBICACIÓN EN TIEMPO REAL ===
    let live=null;
    function onLoc(e){
      if(!live){
        live=L.marker(e.latlng,{
          icon:L.icon({
            iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64113.png",
            iconSize:[20,20],
            iconAnchor:[10,20]
          })
        }).addTo(map).bindPopup("Tú");
      } else live.setLatLng(e.latlng);
    }
    if("geolocation" in navigator){
      setTimeout(()=>{
        map.on("locationfound",onLoc);
        map.locate({watch:true,setView:false,maxZoom:16});
      },1000);
    }
  </script>
</body>
</html>
