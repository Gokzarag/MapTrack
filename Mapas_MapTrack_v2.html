<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapas - MapTrack v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon con el logo, debe ser PNG o SVG transparente para mejor resultado -->
  <link rel="icon" type="image/png" href="https://drive.google.com/thumbnail?id=1IsdjqNmcsKNnVYBOyb19WdgWQGMBf3vV" />
  <!-- Leaflet y PapaParse -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      max-width: 950px;
      margin: 0 auto;
      background: #f7faff;
      color: #23272f;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .header-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 32px 0 18px 0;
      background: #ffffffcc;
      border-radius: 18px;
      box-shadow: 0 8px 32px #b2cfff4d;
      margin-top: 32px;
      margin-bottom: 22px;
      justify-content: flex-start;
    }
    .header-row img {
      height: 54px;
      width: 54px;
      border-radius: 50%;
      box-shadow: 0 2px 18px #32baff25;
      object-fit: cover;
      background: #eaf7ff;
      border: 2px solid #ccedff;
      /* Quita el cuadro blanco, marcando fondo circular */
      display: block;
    }
    .header-row h2 {
      letter-spacing: 0.01em;
      font-size: 1.55em;
      color: #006af6;
      background: linear-gradient(90deg, #41d8fc 20%, #3561db 80%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .filtros-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 17px;
      background: #f3f8ffea;
      border-radius: 13px;
      padding: 13px 19px;
      box-shadow: 0 2px 8px #d3e3ff60;
      margin-bottom: 10px;
      margin-top: 10px;
    }
    label {
      font-size: 1.01em;
      color: #004486;
      font-weight: 500;
    }
    select {
      font-size: 1em;
      padding: 8px 26px 8px 12px;
      border-radius: 7px;
      border: none;
      background: #f5faff;
      box-shadow: 0 2px 8px #afceff22 inset;
      color: #283349;
      transition: box-shadow 0.16s, border 0.16s;
      margin-left: 2px;
      margin-right: 14px;
      appearance: none;
      cursor: pointer;
      font-family: inherit;
      outline: none;
    }
    select:focus {
      box-shadow: 0 0 0 2px #009aea33, 0 2px 8px #afceff22 inset;
      border: 1.5px solid #009aea;
    }
    .fecha-entrega {
      margin: 17px 0 0 6px;
      font-size: 1.02em;
      color: #2563eb;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    #map {
      height: 540px;
      width: 99%;
      min-width: 312px;
      min-height: 330px;
      margin: 18px auto 0 auto;
      background: #f5f9ff;
      border-radius: 16px;
      box-shadow: 0 8px 30px #b6d7ef35, 0 2px 5px #a4aeb833;
      border: 1.8px solid #e5eefd;
      transition: box-shadow 0.17s;
    }
    .nombre-link {
      word-break: break-all;
      font-weight: 700;
      text-decoration: underline dotted;
      display: inline-block;
      color: #3483ff;
      font-size: 1.05em;
      transition: color 0.14s;
    }
    .nombre-link:hover {
      color: #60e4b0;
      text-decoration-color: #36e8bd;
    }
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      background: #fafdffec;
      box-shadow: 0 6px 16px #8ab6fc40;
      border: 1px solid #cbe6ff;
    }
    .leaflet-popup-content {
      font-size: 1.01em;
      color: #124;
      font-family: inherit;
    }
    ::-webkit-scrollbar {
      height: 13px;
      width: 10px;
      background: #f1f3fa;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: #d1eaff;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #b4e1fc;
    }
    @media (max-width: 700px) {
      .header-row {
        flex-direction: row;
        gap: 13px;
        margin-top: 8vw;
        margin-bottom: 2vw;
        padding: 12px 0 7px 0;
      }
      .header-row h2 {
        font-size: 1.13em;
      }
      .filtros-row {
        padding: 7px 7vw;
        font-size: 0.98em;
        gap: 9px;
        margin-left: 0;
        margin-right: 0;
      }
      #map {
        height: 290px;
        min-width: 99vw;
        min-height: 220px;
        border-radius: 8px;
      }
      .fecha-entrega {
        font-size: 0.98em;
        margin-top: 10px;
      }
    }
    select, #map, .filtros-row {
      transition: box-shadow 0.19s, border 0.19s;
    }
    select:hover {
      box-shadow: 0 0 0 2px #d9f3ff;
    }
    h2, .header-row h2 {
      transition: background 0.3s, color 0.3s;
    }
  </style>
</head>
<body>
  <div class="header-row">
    <img src="https://drive.google.com/thumbnail?id=1IsdjqNmcsKNnVYBOyb19WdgWQGMBf3vV" alt="Logo MapTrack" />
    <h2>Mapas - MapTrack v2.0</h2>
  </div>
  <div class="filtros-row">
    <label for="placa">Placa:</label>
    <select id="placa"></select>
    <label for="cliente">Cliente:</label>
    <select id="cliente"></select>
  </div>
  <div class="fecha-entrega" id="fechaEntrega"></div>
  <div id="map"></div>
  <script>
    const csv_url = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';
    const COL_PLACA = 'Vehicle Key/Placa';
    const COL_CODIGO_CLIENTE = 'Customer Account # / Cliente';
    const COL_NOMBRE_CLIENTE = 'Customer Name/Solic';
    const COL_ERROR = 'Customer Name2';
    const COL_CITY = 'City';
    const COL_ADDRESS = 'Address';
    const COL_LAT = 'Latitude';
    const COL_LNG = 'Longitude';
    const COL_FECHA = 'Fecha de Entrega';
    function toDDMMYYYY(fechaStr) {
      if (!fechaStr) return '';
      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(fechaStr.trim())) {
        let [a,m,d] = fechaStr.trim().split('-');
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${a}`;
      }
      let sep = fechaStr.includes('/') ? '/' : '-';
      let [p1, p2, p3] = fechaStr.trim().split(sep);
      if (p3 && p3.length === 4) {
        let d = parseInt(p1, 10), m = parseInt(p2, 10), y = parseInt(p3, 10);
        if (m>12) { [d,m]=[m,d]; }
        return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;
      }
      return fechaStr;
    }
    function getColorForString(str, total) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash) % total;
      return `hsl(${Math.round(hue * (360 / total))},75%,49%)`;
    }
    function makeCustomMarker(color) {
      const svg = encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="29" viewBox="0 0 20 29"><path d="M10 0C4.5 0 0 4.6 0 10.2 0 18.4 8.8 28.1 9.2 28.6c.4.5 1.2.5 1.6 0C11.2 28.1 20 18.4 20 10.2 20 4.6 15.5 0 10 0zm0 13.5c-2.1 0-3.7-1.7-3.7-3.7S7.9 6 10 6s3.7 1.7 3.7 3.7-1.7 3.8-3.7 3.8z" fill="${color}"/></svg>`
      );
      return L.icon({
        iconUrl: "data:image/svg+xml," + svg,
        iconSize: [20, 29],
        iconAnchor: [10, 29],
        popupAnchor: [0, -25]
      });
    }
    let rawData = [];
    let map, markers = [];
    let firstLoad = true;
    function uniqueBy(arr, keys) {
      const seen = {};
      return arr.filter(row => {
        const key = keys.map(k => row[k]).join('|');
        if (seen[key]) return false;
        seen[key] = true;
        return true;
      });
    }
    function createMap(latDefault = -12.1, lngDefault = -77.0) {
      map = L.map('map').setView([latDefault, lngDefault], 12);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://carto.com/">CartoDB</a> &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
    }
    function plotMarkers(data) {
      if (markers.length > 0) for (const m of markers) map.removeLayer(m);
      markers = [];
      if (data.length === 0) return;
      const clientesUnique = [...new Set(data.map(row => row[COL_NOMBRE_CLIENTE]))];
      const colorMap = {};
      clientesUnique.forEach((cliente, i) => {
        colorMap[cliente] = getColorForString(cliente, clientesUnique.length+2);
      });
      let any = false;
      for (const row of data) {
        const lat = parseFloat(row[COL_LAT]);
        const lng = parseFloat(row[COL_LNG]);
        if (!lat || !lng) continue;
        let clienteLabel = row[COL_NOMBRE_CLIENTE];
        const comentario = row[COL_ERROR];
        if (comentario && !['', 'error', '(blank)', '(blanco)', ' '].includes((comentario||"").trim().toLowerCase())) {
          clienteLabel += ` (${comentario})`;
        }
        const direccion = `${row[COL_ADDRESS]} - ${row[COL_CITY]}`;
        const gmaps = `https://www.google.com/maps?q=${lat},${lng}`;
        const popup = `
          <div style="font-size:1em;">
            <a class="nombre-link" href="${gmaps}" target="_blank"
               style="color:${colorMap[row[COL_NOMBRE_CLIENTE]]};text-decoration:underline;font-weight:bold;">
              ${clienteLabel}
            </a><br>
            <span>${direccion}</span>
          </div>
        `;
        const marker = L.marker([lat, lng], { icon: makeCustomMarker(colorMap[row[COL_NOMBRE_CLIENTE]]) });
        marker.bindPopup(popup, {maxWidth: 300});
        marker.on('click', function(e) {
           marker.openPopup();
        });
        marker.addTo(map);
        markers.push(marker);
        if (!any) {
          map.setView([lat, lng], 15);
          any = true;
        }
      }
    }
    function filtrarComboClientes(placa) {
      const clientesSet = new Set();
      rawData.filter(row => row[COL_PLACA] === placa)
             .forEach(row => clientesSet.add(row[COL_NOMBRE_CLIENTE]));
      const clientes = Array.from(clientesSet).sort();
      const sel = document.getElementById('cliente');
      sel.innerHTML = '<option value="">Todos</option>' + clientes.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    function filtrarYRenderizar() {
      const placaSel = document.getElementById('placa').value;
      const clienteSel = document.getElementById('cliente').value;
      let data = rawData.filter(row => row[COL_PLACA] === placaSel);
      if (clienteSel) data = data.filter(row => row[COL_NOMBRE_CLIENTE] === clienteSel);
      data = uniqueBy(data, [COL_PLACA, COL_CODIGO_CLIENTE]);
      plotMarkers(data);
      let fecha = '';
      if (data.length > 0) fecha = data[0][COL_FECHA];
      let fechaDDMMYYYY = fecha ? toDDMMYYYY(fecha) : '';
      document.getElementById('fechaEntrega').textContent = fechaDDMMYYYY ? ('Fecha de entrega: ' + fechaDDMMYYYY) : '';
    }
    Papa.parse(csv_url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        rawData = results.data.filter(row =>
          row[COL_PLACA] && row[COL_CODIGO_CLIENTE] && row[COL_LAT] && row[COL_LNG] &&
          !isNaN(parseFloat(row[COL_LAT])) &&
          !isNaN(parseFloat(row[COL_LNG]))
        );
        const placas = [...new Set(rawData.map(row => row[COL_PLACA]))];
        const sel = document.getElementById('placa');
        sel.innerHTML = placas.map((p, i) => `<option value="${p}"${i===0?' selected':''}>${p}</option>`).join('');
        filtrarComboClientes(placas[0]);
        if (rawData.length > 0) {
          let fechaTexto = rawData[COL_FECHA] ? toDDMMYYYY(rawData[COL_FECHA]) : '';
          document.getElementById('fechaEntrega').textContent = fechaTexto ? ('Fecha de entrega: ' + fechaTexto) : '';
        }
        if (firstLoad) {
          createMap();
          filtrarYRenderizar();
          firstLoad = false;
        }
      }
    });
    document.getElementById('placa').addEventListener('change', function(e) {
      filtrarComboClientes(e.target.value);
      filtrarYRenderizar();
    });
    document.getElementById('cliente').addEventListener('change', filtrarYRenderizar);
  </script>
</body>
</html>

