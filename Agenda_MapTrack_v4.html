<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda_Maptrack_v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Calibri, Arial, sans-serif;
      margin: 0;
      background: #fafcff;
      color: #222;
    }
    .header-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 3px;
      margin: 20px 7px 2px 7px;
    }
    .logo-outer {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 5px;
      width: 48px; height: 48px;
    }
    .logo-circle {
      width: 45px;
      height: 45px;
      min-width: 45px;
      min-height: 45px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 8px #e9e9ee77;
      padding: 2px;
    }
    .logo-circle img {
      width: 32px;
      height: 32px;
      display: block;
      border-radius: 50%;
      object-fit: cover;
    }
    .header-title {
      font-size: 1.13em;
      font-weight: bold;
      margin: 0 0 0 5px;
      line-height: 1.06;
      letter-spacing: 0.1px;
      margin-bottom: -2px;
    }
    .fecha-entrega {
      margin: 5px 0 13px 7px;
      font-weight: 600;
      font-size: 0.97em;
      color: #222;
    }
    .buscador-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 5px;
      width: 99vw;
      max-width: 470px;
      margin: 0 7px 13px 7px;
    }
    input[type="text"].buscador-principal {
      font-size: 13.8px;
      padding: 9px 11px 9px 13px;
      border: 1.6px solid #edcdcf;
      border-radius: 13px 0 0 13px;
      width: 74vw;
      max-width:340px;
      background: #fbf8fa;
      box-sizing: border-box;
      outline: none;
      margin-right: 0;
      transition: border 0.1s;
    }
    input[type="text"].buscador-principal:focus {
      border: 1.6px solid #e95567;
      background: #fff8fa;
    }
    .buscador-container button {
      font-size: 13.4px;
      padding: 8.8px 17px 8.8px 13px;
      color: white;
      background: #f2828e;
      border: none;
      border-radius: 0 13px 13px 0;
      cursor: pointer;
      font-family: Calibri, Arial, sans-serif;
      box-shadow: 0 0 2.1px #dc5e5e91;
      font-weight: 600;
      height: 39px;
      min-width: 105px;
      letter-spacing: 0.3px;
      margin-left: -3px;
      transition: background 0.17s;
    }
    .buscador-container button:active, .buscador-container button:focus {
      background: #e64d5b;
    }
    .agenda-scroll-x {
      overflow-x: auto;
      width: 100vw;
      margin: 0 1px;
      margin-bottom: 24px;
    }
    table {
      border-collapse: collapse;
      margin: 0;
      width: 1080px;
      min-width: 740px;
      background: #fff;
      border-radius: 10px;
      font-family: Calibri, Arial, sans-serif;
    }
    th, td {
      text-align: left;
      font-size: 12px;
      padding: 7px 8px 7px 7px;
      border-bottom: 1.2px solid #f7e1e2;
      max-width: 280px;
      overflow-wrap: break-word;
    }
    th {
      background: #f8c6c6;
      color: #403535;
      font-size: 13.4px;
      font-weight: 700;
      letter-spacing: 0.44px;
      border-bottom: 2.5px solid #e05d56;
      position: sticky;
      top: 0;
      z-index: 1;
      box-shadow: 0 2px 8px -5px #ee7575d1;
    }
    tr:active, tr.resaltado, tr.selected-row {
      background: #f2eaeb !important;
      transition: background 0.12s;
    }
    tr:hover { background: #fff2f7; }
    a {
      color: #99034f;
      text-decoration: underline;
      word-break: break-all;
    }
    @media (max-width: 770px) {
      table { min-width:630px; font-size:10.6px; }
      th, td { font-size:11px;}
    }
    @media (max-width:600px) {
      .header-block { margin:23px 3px 0 2px;}
      .fecha-entrega {margin-left:2px;}
      .header-title {font-size:1em;}
      .logo-outer{width:32px;height:32px;}
      .logo-circle{width:30px; height:30px;}
      .logo-circle img{width:20px;height:20px;}
      .buscador-container{max-width:100vw; margin-left:0;}
      .buscador-container input{ font-size:10.8px; max-width:60vw;}
      .buscador-container button{font-size:10.1px; padding:7px 10px; height:35px;}
      th, td { font-size:9.3px;}
      .agenda-scroll-x{margin:0;}
    }
  </style>
</head>
<body>
  <div class="header-block">
    <div class="logo-outer">
      <div class="logo-circle">
        <img src="https://drive.google.com/thumbnail?id=11yaeiYnsBYXFX46VNs_5ARJ_E8fDBHzw" alt="Logo">
      </div>
    </div>
    <div>
      <div class="header-title">Agenda Maptrack v4</div>
      <div class="fecha-entrega" id="fecha-entrega"></div>
    </div>
  </div>
  <div class="buscador-container">
    <input type="text" id="buscador-principal" class="buscador-principal"
      placeholder="Buscar en toda la agenda..." oninput="onGlobalSearchInput()">
    <button onclick="nuevaBusqueda()">Nueva búsqueda</button>
  </div>
  <div class="agenda-scroll-x">
    <table id="agenda-table">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Solicitante</th>
          <th>Ruta Venta</th>
          <th>Placa</th>
          <th>Asignación</th>
          <th>Teléfono</th>
          <th>Dirección</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
const CSV_URL = 'https://raw.githubusercontent.com/Gokzarag/MapTrack/main/MapTrack_V2.1.csv';
let dataRows = [];
let buscadorGlobal = '';

function toDDMMYYYY(fechaStr) {
  if (!fechaStr) return '';
  if (/^\d{4}-\d{2}-\d{2}/.test(fechaStr.trim())) {
    let [a, m, d] = fechaStr.trim().split('-');
    return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${a}`;
  }
  let sep = fechaStr.includes('/') ? '/' : '-';
  let [p1, p2, p3] = fechaStr.trim().split(sep);
  if (p3 && p3.length === 4) {
    let d = parseInt(p1, 10), m = parseInt(p2, 10), y = parseInt(p3, 10);
    if (m > 12) [d, m] = [m, d];
    return `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;
  }
  return fechaStr;
}

function matchCabecera(posibles, headers) {
  const norm = s => s.toLowerCase().replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9#]/g, '');
  for (let pos of posibles) {
    let npos = norm(pos);
    for (let h of headers) {
      if (norm(h) === npos) return h;
    }
  }
  return null;
}

function safeField(row, keys) {
  for (let k of keys) {
    if (row[k] !== undefined && (row[k] + '').trim() !== '') return (row[k] + '').trim();
  }
  return '';
}

function loadCSV() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function (results) {
      const rows = results.data;
      const headers = Object.keys(rows[0]);
      const colC = matchCabecera(['Vehicle Key/Placa', 'Placa'], headers);
      const colD = matchCabecera(['Customer Account # / Cliente', 'Cliente', 'Account', 'Cuenta'], headers);
      const colE = matchCabecera(['Customer Name/Solic', 'Solicitante', 'Solic'], headers);
      const colF = matchCabecera(['Customer Name2', 'Solicitante 2', 'Solic2'], headers);
      const colG = matchCabecera(['RUTA VENTA', 'Ruta Venta', 'Ruta'], headers);
      const colM = matchCabecera(['Asignación', 'Asignacion', 'Asignación'], headers);
      const telefonoCols = headers.filter(h => {
        const norm = h.toLowerCase().replace(/[\u0300-\u036f]/g, '');
        return /\btel(e?fono)?\b/.test(norm);
      });
      const colP = matchCabecera(['Address', 'Dirección', 'Direccion'], headers);
      const colO = matchCabecera(['City', 'Ciudad'], headers);
      const colH = matchCabecera(['#Pedido/Doc comer', 'Pedido', '#Pedido', 'Doc'], headers);
      const colA = matchCabecera(['Fecha de Entrega', 'Fecha Entrega', 'Entrega'], headers);
      const colQ = matchCabecera(['Latitude', 'Latitud'], headers);
      const colR = matchCabecera(['Longitude', 'Longitud'], headers);

      dataRows = getUnique(rows.map(row => {
        let E = safeField(row, [colE]);
        let F = safeField(row, [colF]);
        let fullSolic = (F && !['0', '#N/A', '(blank)', '', ' '].includes(F)) ? `${E} - ${F}` : E;
        let address = safeField(row, [colP]);
        let city = safeField(row, [colO]);
        let dirCity = address + (city ? ' - ' + city : '');
        let lat = safeField(row, [colQ]);
        let lng = safeField(row, [colR]);
        let mapLink = (lat && lng) ? `<a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank">${dirCity}</a>` : dirCity;
        let fecha = toDDMMYYYY(safeField(row, [colA]));
        let M = safeField(row, [colM]);
        let N = safeField(row, telefonoCols);
        return {
          Cliente: safeField(row, [colD]),
          Solicitante: fullSolic,
          RutaVenta: safeField(row, [colG]),
          Placa: safeField(row, [colC]),
          Asignacion: M,
          Telefono: N,
          Direccion: mapLink,
          FechaEntrega: fecha,
          Pedido: safeField(row, [colH]),
        };
      }));
      mostrarFechaEntrega(dataRows);
      renderTable();
    }
  });
}

function getUnique(arr) {
  const seen = new Set();
  return arr.filter(row => {
    const key = [
      row.Cliente, row.Solicitante, row.RutaVenta,
      row.Placa, row.Asignacion, row.Telefono, row.Direccion
    ].join('|').toLowerCase();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

window.onGlobalSearchInput = function () {
  buscadorGlobal = document.getElementById('buscador-principal').value.trim().toLowerCase();
  renderTable();
};

window.nuevaBusqueda = function () {
  buscadorGlobal = '';
  document.getElementById('buscador-principal').value = '';
  renderTable();
};

function match(row) {
  if (buscadorGlobal && buscadorGlobal !== '') {
    let val = [
      row.Cliente, row.Solicitante, row.RutaVenta, row.Placa,
      row.Asignacion, row.Telefono, row.Direccion, row.Pedido
    ].join(' ').toLowerCase();
    if (!val.includes(buscadorGlobal)) return false;
  }
  return true;
}

function renderTable() {
  let tbody = document.querySelector('#agenda-table tbody');
  let fragment = document.createDocumentFragment();
  let rowsShow = dataRows.filter(row => match(row));
  for (let i = 0; i < rowsShow.length && i < 250; i++) {
    let row = rowsShow[i];
    let tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${row.Cliente}</td>
        <td>${row.Solicitante}</td>
        <td>${row.RutaVenta}</td>
        <td>${row.Placa}</td>
        <td>${row.Asignacion}</td>
        <td>${row.Telefono}</td>
        <td>${row.Direccion}</td>
    `;
    tr.addEventListener('touchstart', ()=> tr.classList.add('resaltado'));
    tr.addEventListener('touchend', ()=> setTimeout(()=>tr.classList.remove('resaltado'),180));
    fragment.appendChild(tr);
  }
  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}

function mostrarFechaEntrega(rows) {
  let fechas = rows.map(r => r.FechaEntrega).filter(f => f && f !== '00/00/0000' && f !== '0/0/0000');
  fechas.sort((a, b) => {
    let [da, ma, aa] = a.split('/').map(Number), [db, mb, ab] = b.split('/').map(Number);
    let dA = new Date(aa, ma - 1, da), dB = new Date(ab, mb - 1, db);
    return dA - dB;
  });
  let fechaMostrar = fechas.length ? fechas[0] : '';
  let textoFecha = fechaMostrar ? `Fecha de entrega: ${fechaMostrar}` : '';
  document.getElementById('fecha-entrega').textContent = textoFecha;
}

window.onload = loadCSV;
</script>
</body>
</html>